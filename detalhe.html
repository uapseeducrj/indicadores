<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Indicador - Painel de Monitoramento</title>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">

    <style>
        :root {
            --color-primary: #003d7a;
            --color-secondary: #0074d9;
            --color-background-light: #f7f9fb;
            --color-text-dark: #2f3e4e;
            --color-text-light: #7a8a9c;
            --color-positive: #2e7d32;
            --color-negative: #c62828;
            --color-neutral: #ffb300;
            --color-gray: #9e9e9e;
            --color-tactical: #005e63;
            --color-responsible: #6a1b9a;
            --color-source: #2e7d32;
            --color-hiperpositive: #00f729;
            --color-meta-2025: #9370db;
            --color-meta-2026: #87cefa;
            --color-gauge-track: #dcdcdc;
            --color-chart-line: #2196F3;
            --color-chart-area: #B3E5FC;
            --color-detail-card: #eef1f4;
            --color-detail-text: #4a4a4a;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: "Inter", "Segoe UI", sans-serif;
            background-color: var(--color-background-light);
            color: var(--color-text-dark);
            margin: 0;
            padding: 15px;
            height: 100vh;
            overflow: hidden;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            font-size: 20px;
            margin-right: 8px;
            vertical-align: middle;
        }

        .back-button {
            display: inline-block;
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: 600;
            text-decoration: none;
            color: white;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            background-color: var(--color-secondary);
            margin-bottom: 15px;
            font-size: 14px;
        }
        .back-button:hover {
            background-color: #005ea8;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            height: calc(100vh - 30px);
            display: flex;
            flex-direction: column;
        }

        .header {
            background-color: #fff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
            border-left: 4px solid var(--color-primary);
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .header-content {
            flex: 1;
        }

        .header h1 {
            color: var(--color-primary);
            font-size: 20px;
            font-weight: 700;
            margin: 0 0 8px 0;
            line-height: 1.3;
        }

        .header p {
            color: var(--color-text-light);
            font-size: 13px;
            margin: 0;
            line-height: 1.4;
        }

        /* DROPDOWN STYLES */
        .indicators-dropdown {
            position: relative;
            margin-left: 20px;
            flex-shrink: 0;
        }

        .dropdown-button {
            background-color: var(--color-primary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }

        .dropdown-button:hover {
            background-color: #002d5b;
        }

        .dropdown-list {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 300px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .dropdown-list.show {
            display: block;
        }

        .dropdown-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .indicator-name {
            font-weight: 500;
            font-size: 13px;
            flex: 1;
        }

        .indicator-value {
            font-size: 12px;
            font-weight: bold;
            color: var(--color-primary);
            margin-left: 10px;
        }

        .indicator-status {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 8px;
            color: white;
        }

        .status-positive { background-color: var(--color-positive); }
        .status-negative { background-color: var(--color-negative); }
        .status-neutral { background-color: var(--color-neutral); }
        .status-gray { background-color: var(--color-gray); }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 15px;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-height: 0;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 0;
        }

        .card {
            background-color: #fff;
            border-radius: 6px;
            padding: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #eee;
            flex-shrink: 0;
        }

        /* --- MUDANÇAS NA ESTRUTURA DO GRÁFICO (CHART) --- */
        .chart-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .chart-card {
            padding: 12px;
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .chart-title {
            font-size: 11px;
            margin: 0 0 5px 0;
            color: var(--color-text-light);
            flex-shrink: 0;
        }

        /* NOVO CONTÊINER FLEXÍVEL PARA PLOTAGEM */
        .chart-wrapper {
            flex: 1;
            display: flex;
            position: relative;
            min-height: 0;
            padding-bottom: 30px;
            width: 100%;
        }

        /* Contêiner da área de plotagem (sem Eixo Y) */
        .chart-container {
            flex-grow: 1;
            position: relative;
            border-bottom: 1px solid #ddd;
            border-left: 1px solid #ddd;
            margin-left: 40px;
            overflow: visible;
        }

        /* SVG e contêineres de dados cobrindo 100% da área de plotagem */
        .chart-svg, #grid-lines-container, #data-points-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* Eixo Y (Rótulos) */
        #y-axis-container {
            position: absolute;
            left: 0;
            top: 0;
            width: 40px;
            height: 100%;
        }
        .y-axis-label {
            position: absolute;
            right: 5px;
            transform: translateY(-50%);
            font-size: 10px;
            color: var(--color-text-light);
            text-align: right;
            padding-right: 2px;
        }

        /* Linhas de Grade */
        .grid-line {
            position: absolute;
            border-top: 1px dashed #eee;
            width: 100%;
            left: 0;
            pointer-events: none;
        }

        /* Contêiner dos Rótulos X (Anos) */
        #x-axis-labels-container {
            position: absolute;
            bottom: 0;
            left: 40px;
            width: calc(100% - 40px);
            height: 30px;
            pointer-events: none;
            overflow: visible;
        }

        /* Rótulo do ano - POSIÇÃO CORRIGIDA */
        .x-axis-bar-label {
            font-size: 10px;
            color: var(--color-text-light);
            text-align: center;
            white-space: nowrap;
            position: absolute;
            bottom: 5px;
            transform: translateX(-50%);
            pointer-events: none;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid #eee;
            font-weight: bold;
            z-index: 5;
            min-width: 40px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* Estilo das barras no SVG */
        .chart-bar {
            transition: fill 0.2s;
        }

        /* Placeholder para tooltip */
        .data-point-placeholder {
            position: absolute;
            width: 12px;
            height: 100%;
            transform: translateX(-50%);
            cursor: pointer;
            z-index: 10;
        }

        .data-point-placeholder:hover::after {
            content: attr(data-value);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 100;
            font-weight: 600;
        }

        /* Estilo para os valores sobre as barras */
        .bar-value-label {
            position: absolute;
            font-size: 9px;
            font-weight: 600;
            color: var(--color-text-dark);
            text-align: center;
            transform: translateX(-50%);
            pointer-events: none;
            z-index: 20;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 1px 3px;
            border-radius: 2px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            white-space: nowrap;
        }
        /* --- FIM DAS MUDANÇAS NO GRÁFICO --- */

        .details-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            height: 100px;
        }

        .indicator-details-card, .meta-card-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .indicator-details-card .card, .meta-card-container .card {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .indicator-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            flex: 1;
        }

        .meta-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            flex: 1;
            height: 100%;
        }

        .indicator-detail, .meta-card {
            text-align: center;
            padding: 8px 0;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            background-color: var(--color-detail-card);
            color: var(--color-detail-text);
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
            min-height: 50px;
        }

        .indicator-detail .label, .meta-card .meta-label {
            font-size: 8px;
            color: var(--color-text-light);
            text-transform: uppercase;
            margin-top: 1px;
        }

        .indicator-detail .value, .meta-card .meta-value {
            font-size: 12px;
            font-weight: bold;
            color: var(--color-detail-text);
            margin-bottom: 1px;
        }

        .info-card {
            background-color: #fff;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #eee;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            flex: 1;
            min-height: 0;
        }

        .info-card .label {
            font-size: 9px;
            text-transform: uppercase;
            color: var(--color-text-light);
            margin-top: 6px;
            display: block;
            border-top: 1px solid #eee;
            padding-top: 6px;
            text-align: center;
            flex-shrink: 0;
        }

        .info-card .status-title {
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            margin: 0;
            padding-top: 3px;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .formula-card .content {
            font-size: 12px;
            line-height: 1.3;
            text-align: center;
            margin: 0;
            flex-grow: 1;
        }

        .info-card p {
            margin: 0;
            font-size: 12px;
            line-height: 1.3;
            flex-grow: 1;
            display: flex;
            align-items: center;
            text-align: center;
            justify-content: center;
        }

        .footer-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            padding: 0;
            height: 100%;
        }

        .footer-detail {
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
        }

        .footer-detail .label {
            font-size: 8px;
            text-transform: uppercase;
            color: var(--color-text-light);
            margin-top: auto;
            padding-top: 6px;
            border-top: 1px solid #eee;
            text-align: center;
            flex-shrink: 0;
        }

        .footer-detail .value {
            font-size: 11px;
            font-weight: bold;
            line-height: 1.2;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            flex-grow: 1;
            margin-bottom: 4px;
        }

        .section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--color-text-dark);
            margin: 0 0 8px 0;
            flex-shrink: 0;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--color-text-light);
        }

        .polarity-icon {
            font-size: 24px;
            display: inline-block;
            vertical-align: middle;
            line-height: 1;
        }

        /* Estilo especial para as metas com cores diferentes */
        .meta-2025 {
            border-left: 3px solid var(--color-meta-2025);
        }

        .meta-2026 {
            border-left: 3px solid var(--color-meta-2026);
        }
    </style>
</head>
<body>
    <div class="dashboard-container" id="dashboard-container">
        <a href="#" onclick="navigate('?page=dashboard'); return false;" class="back-button">← Voltar ao Dashboard</a>

        <div class="header">
            <div class="header-content">
                <h1 id="indicator-name">Carregando detalhes do indicador...</h1>
                <p id="indicator-description">Aguarde enquanto carregamos as informações</p>
            </div>

            <div class="indicators-dropdown">
                <button class="dropdown-button" onclick="toggleDropdown()">
                    Outros Indicadores
                </button>
                <div class="dropdown-list" id="indicators-dropdown-list">
                    <div class="dropdown-item">
                        <div class="indicator-name">Carregando...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <div class="chart-section">
                    <div class="card chart-card">
                        <p class="chart-title">Série Histórica do Indicador</p>

                        <div class="chart-wrapper">
                            <div id="y-axis-container"></div>

                            <div class="chart-container">
                                <div id="grid-lines-container"></div>
                                <svg id="chart-svg" class="chart-svg"></svg>
                                <div id="data-points-container"></div>
                                <div id="bar-values-container"></div>
                            </div>

                            <div id="x-axis-labels-container"></div>
                        </div>
                    </div>
                </div>

                <div class="details-section">
                    <div class="indicator-details-card">
                        <div class="card">
                            <p class="section-title">Detalhes do Indicador</p>
                            <div class="indicator-details">
                                <div class="indicator-detail">
                                    <div class="value" id="detail-polaridade">--</div>
                                    <div class="label">Polaridade</div>
                                </div>
                                <div class="indicator-detail">
                                    <div class="value" id="detail-grandeza">--</div>
                                    <div class="label">Grandeza</div>
                                </div>
                                <div class="indicator-detail">
                                    <div class="value" id="detail-periodicidade">--</div>
                                    <div class="label">Periodicidade</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="meta-card-container">
                        <div class="card">
                            <p class="section-title">Metas</p>
                            <div class="meta-cards">
                                <div class="meta-card meta-2025">
                                    <div class="meta-value" id="meta-2025-value-box">N/A</div>
                                    <div class="meta-label">Meta 2025</div>
                                </div>
                                <div class="meta-card meta-2026">
                                    <div class="meta-value" id="meta-2026-value-box">N/A</div>
                                    <div class="meta-label">Meta 2026</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <div class="info-card" id="status-card" style="border-top: 4px solid var(--color-text-light);">
                    <p class="status-title" id="status-value" style="color: var(--color-text-light);">--</p>
                    <span class="label">Status</span>
                </div>

                <div class="info-card">
                    <p id="objetivo-estrategico">Selecione um indicador para ver os detalhes completos</p>
                    <span class="label">Objetivo Estratégico</span>
                </div>

                <div class="info-card">
                    <p id="referencial-meta">--</p>
                    <span class="label">Referencial da Meta</span>
                </div>

                <div class="info-card formula-card">
                    <p class="content" id="formula-content">--</p>
                    <span class="label">Fórmula</span>
                </div>

                <div class="info-card" style="padding: 12px;">
                    <div class="footer-details">
                        <div class="footer-detail">
                            <div class="value" id="fonte-dados">--</div>
                            <span class="label">Fonte dos Dados</span>
                        </div>
                        <div class="footer-detail">
                            <div class="value" id="responsavel">--</div>
                            <span class="label">Responsável</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // DADOS DE FALLBACK AJUSTADOS - incluindo dados com tipo_dado: META
    const fallbackData = [
        {
            "OBJETIVO ESTRATÉGICO": "Acesso à Educação",
            "#": 1.1,
            "INDICADORES": "Taxa líquida de matrícula do ensino médio regular no ERJ",
            "FÓRMULA": "% da população de 15 a 17 anos que frequenta o EM regular ou possui educação básica completa no estado do RJ",
            "FONTE DOS DADOS": "PNADC",
            "EMAIL PESSOA RESPONSÁVEL": 0.0,
            "SUPINTENDÊNCIA": "SUPLAN ",
            "SUBSECRETARIA": "SUBPAE",
            "PERIODICIDADE DE MEDIÇÃO": "Trimestral",
            "GRANDEZA": "%",
            "POLARIDADE": "⬆️",
            "VALOR ATUAL": 0.85,
            "Status": "Dentro do esperado",
            "REFERENCIAL DA META": "Considera meta prevista e pactuada pelo PNE 2014-2024",
            "DOUBLE CHECK": "ok",
            "OBSERVAÇÕES": "Se o indicador é trimestral, conseguimos um número atualizado?",
            "BASE DE DADOS": 0.0,
            "Origem Arquivo": "SEEDUC RJ_Monitoramento de Projetos.xlsx",
            "INDICADOR": "Nível Desconhecido",
            "valor": 0.739,
            "tipo_dado": "VALOR",
            "ano": 2019
        },
        {
            "OBJETIVO ESTRATÉGICO": "Acesso à Educação",
            "INDICADORES": "Taxa líquida de matrícula do ensino médio regular no ERJ",
            "valor": 0.82,
            "tipo_dado": "VALOR",
            "ano": 2021
        },
        {
            "OBJETIVO ESTRATÉGICO": "Acesso à Educação",
            "INDICADORES": "Taxa líquida de matrícula do ensino médio regular no ERJ",
            "valor": 0.85,
            "tipo_dado": "VALOR",
            "ano": 2022
        },
        {
            "OBJETIVO ESTRATÉGICO": "Acesso à Educação",
            "INDICADORES": "Taxa líquida de matrícula do ensino médio regular no ERJ",
            "valor": 0.87,
            "tipo_dado": "VALOR",
            "ano": 2023
        },
        {
            "OBJETIVO ESTRATÉGICO": "Acesso à Educação",
            "INDICADORES": "Taxa líquida de matrícula do ensino médio regular no ERJ",
            "valor": 0.89,
            "tipo_dado": "VALOR",
            "ano": 2024
        },
        {
            "INDICADORES": "Taxa líquida de matrícula do ensino médio regular no ERJ",
            "valor": 0.95,
            "tipo_dado": "META",
            "ano": 2025
        },
        {
            "INDICADORES": "Taxa líquida de matrícula do ensino médio regular no ERJ",
            "valor": 0.98,
            "tipo_dado": "META",
            "ano": 2026
        },
        {
            "OBJETIVO ESTRATÉGICO": "Infraestrutura",
            "#": 2.1,
            "INDICADORES": "Salas de aula climatizadas",
            "FÓRMULA": "Percentual de salas de aula utilizadas climatizadas na rede",
            "FONTE DOS DADOS": "Censo escolar / Dados internos SUPIE",
            "EMAIL PESSOA RESPONSÁVEL": 0.0,
            "SUPINTENDÊNCIA": "SUPIE",
            "SUBSECRETARIA": "SUBAD",
            "PERIODICIDADE DE MEDIÇÃO": "Mensal",
            "GRANDEZA": "%",
            "POLARIDADE": "⬆️",
            "VALOR ATUAL": 0.91,
            "Status": "Meta 2025 alcançada",
            "REFERENCIAL DA META": "Meta do plano de climatização",
            "DOUBLE CHECK": "ok",
            "OBSERVAÇÕES": "",
            "BASE DE DADOS": 0.0,
            "Origem Arquivo": "SEEDUC RJ_Monitoramento de Projetos.xlsx",
            "INDICADOR": "Estratégico",
            "valor": 0.75,
            "tipo_dado": "VALOR",
            "ano": 2019
        },
        {
            "INDICADORES": "Salas de aula climatizadas",
            "valor": 0.82,
            "tipo_dado": "VALOR",
            "ano": 2021
        },
        {
            "INDICADORES": "Salas de aula climatizadas",
            "valor": 0.88,
            "tipo_dado": "VALOR",
            "ano": 2023
        },
        {
            "INDICADORES": "Salas de aula climatizadas",
            "valor": 0.95,
            "tipo_dado": "META",
            "ano": 2025
        },
        {
            "INDICADORES": "Salas de aula climatizadas",
            "valor": 1.0,
            "tipo_dado": "META",
            "ano": 2026
        },
        {
            "OBJETIVO ESTRATÉGICO": "Infraestrutura",
            "#": 2.2,
            "INDICADORES": "Percentual de Escolas com velocidade de Internet adequada",
            "FÓRMULA": "[∑{se [(Velocidade da Internet contratada / Máx(número de matrículas por turno))​≥1 Mbps] então 1 senão 0}]/1198*100",
            "FONTE DOS DADOS": "SUPTI",
            "EMAIL PESSOA RESPONSÁVEL": 0.0,
            "SUPINTENDÊNCIA": "SUPTI",
            "SUBSECRETARIA": "SUBPAE",
            "PERIODICIDADE DE MEDIÇÃO": "Semestral",
            "GRANDEZA": "%",
            "POLARIDADE": "⬆️",
            "VALOR ATUAL": 0.0,
            "Status": "Dados em coleta",
            "REFERENCIAL DA META": "Meta do plano de conectividade",
            "DOUBLE CHECK": "pendente",
            "OBSERVAÇÕES": "Aguardando dados atualizados",
            "BASE DE DADOS": 0.0,
            "Origem Arquivo": "SEEDUC RJ_Monitoramento de Projetos.xlsx",
            "INDICADOR": "Estratégico",
            "valor": 0.45,
            "tipo_dado": "VALOR",
            "ano": 2019
        },
        {
            "INDICADORES": "Percentual de Escolas com velocidade de Internet adequada",
            "valor": 0.55,
            "tipo_dado": "VALOR",
            "ano": 2022
        },
        {
            "INDICADORES": "Percentual de Escolas com velocidade de Internet adequada",
            "valor": 0.70,
            "tipo_dado": "META",
            "ano": 2025
        },
        {
            "INDICADORES": "Percentual de Escolas com velocidade de Internet adequada",
            "valor": 0.85,
            "tipo_dado": "META",
            "ano": 2026
        },
        {
            "OBJETIVO ESTRATÉGICO": "Aprendizagem Equitativa",
            "#": 4.4,
            "INDICADORES": "Número de premiações da rede em Olimpíadas escolares",
            "FÓRMULA": "Nº de Premiações recebidas pela rede",
            "FONTE DOS DADOS": "Olimpiando",
            "EMAIL PESSOA RESPONSÁVEL": 0.0,
            "SUPINTENDÊNCIA": "SUPAA",
            "SUBSECRETARIA": "SUBGEN",
            "PERIODICIDADE DE MEDIÇÃO": "Anual",
            "GRANDEZA": "Nº",
            "POLARIDADE": "⬆️",
            "VALOR ATUAL": 0.0,
            "Status": "Indicador em coleta",
            "REFERENCIAL DA META": "Aumentar em 5% o número de premiações por ano ",
            "DOUBLE CHECK": "ok",
            "OBSERVAÇÕES": "Repensar periodicidade",
            "BASE DE DADOS": 0.0,
            "Origem Arquivo": "SEEDUC RJ_Monitoramento de Projetos.xlsx",
            "INDICADOR": "Nível Desconhecido",
            "valor": 1804.0,
            "tipo_dado": "VALOR",
            "ano": 2024
        },
        {
            "INDICADORES": "Número de premiações da rede em Olimpíadas escolares",
            "valor": 1894.2,
            "tipo_dado": "META",
            "ano": 2025
        },
        {
            "INDICADORES": "Número de premiações da rede em Olimpíadas escolares",
            "valor": 1988.9,
            "tipo_dado": "META",
            "ano": 2026
        },
        {
            "OBJETIVO ESTRATÉGICO": "Educação Inclusiva e Acessível",
            "#": 5.1,
            "INDICADORES": "Profissionais formados na EE",
            "FÓRMULA": "Σ Docentes e Profissionais com Formação na Educação Especial (120h)",
            "FONTE DOS DADOS": "LabEaD / Moodle",
            "EMAIL PESSOA RESPONSÁVEL": 0.0,
            "SUPINTENDÊNCIA": "SUPPEE",
            "SUBSECRETARIA": "SUBPAE",
            "PERIODICIDADE DE MEDIÇÃO": "Mensal",
            "GRANDEZA": "Nº",
            "POLARIDADE": "⬆️",
            "VALOR ATUAL": 0.0,
            "Status": "Indicador em coleta",
            "REFERENCIAL DA META": "Prevê 90% de conclusão da carga horária nos inscritos em 2 cursos para 2025, além de um incremento de 20% em 2026.",
            "DOUBLE CHECK": "ok",
            "OBSERVAÇÕES": "Coletar dados atualizados!",
            "BASE DE DADOS": 0.0,
            "Origem Arquivo": "SEEDUC RJ_Monitoramento de Projetos.xlsx",
            "INDICADOR": "Nível Desconhecido",
            "valor": 622.0,
            "tipo_dado": "VALOR",
            "ano": 2024
        },
        {
            "INDICADORES": "Profissionais formados na EE",
            "valor": 746.4,
            "tipo_dado": "META",
            "ano": 2025
        },
        {
            "INDICADORES": "Profissionais formados na EE",
            "valor": 895.7,
            "tipo_dado": "META",
            "ano": 2026
        }
    ];

    function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        return {
            indicador: params.get('indicador')
        };
    }

    function navigate(path) {
        if (path.startsWith('?')) {
            const targetPage = path.includes('dashboard') ? 'index.html' : 'detalhe.html';
            window.location.href = `${targetPage}${path}`;
            return;
        }
        window.location.href = path;
    }

    // FUNÇÃO FORMATVALUE CORRIGIDA - COM 1 CASA DECIMAL
    function formatValue(value, grandeza, decimals = 1) {
        if (value === null || value === undefined) return 'N/A';
        const isPercentage = grandeza === '%';

        if (isPercentage) {
            // Para percentuais: multiplicar por 100 e formatar com 1 casa decimal
            return (value * 100).toFixed(1).replace('.', ',') + '%';
        }
        
        // Para números: formatar com 1 casa decimal
        if (typeof value === 'number') {
            // Se for número inteiro grande, formatar com separador de milhar e 1 casa decimal
            if (value >= 1000) {
                return value.toFixed(1).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            }
            // Para números menores, apenas 1 casa decimal
            return value.toFixed(1).replace('.', ',');
        }
        
        return value.toString();
    }

    function getStatusColor(status) {
        const normalizedStatus = normalizeStatus(status);

        switch (normalizedStatus) {
            case 'Dentro do esperado':
            case 'Meta 2025 alcançada':
                return 'var(--color-positive)';
            case 'Abaixo do esperado':
                return 'var(--color-negative)';
            case 'Dados em Coleta':
            case 'Indicador em coleta':
                return 'var(--color-gray)';
            default:
                return 'var(--color-text-light)';
        }
    }

    function normalizeStatus(status) {
        if (!status) return 'Dados em Coleta';

        const normalizedStatus = status.toString().trim();

        if (normalizedStatus === 'Dados em coleta' || normalizedStatus === 'INDICADOR EM COLETA' ||
            normalizedStatus === 'Dados em Coleta' || normalizedStatus === 'Indicador em coleta') {
            return 'Dados em Coleta';
        }

        return normalizedStatus;
    }

    function getStatusClass(status) {
        const normalizedStatus = normalizeStatus(status);

        switch (normalizedStatus) {
            case 'Dentro do esperado':
                return 'status-positive';
            case 'Meta 2025 alcançada':
                return 'status-positive';
            case 'Abaixo do esperado':
                return 'status-negative';
            case 'Dados em Coleta':
                return 'status-gray';
            default:
                return 'status-gray';
        }
    }

    function loadData() {
        try {
            const storedData = localStorage.getItem('dashboardData');
            if (storedData) {
                return JSON.parse(storedData);
            }
        } catch (e) {
            console.log('Erro ao carregar do localStorage, usando fallback');
        }
        return fallbackData;
    }

    // FUNÇÃO CORRIGIDA: getCurrentValue com fallbacks múltiplos
    function getCurrentValue(indicatorData) {
        // Prioridade 1: VALOR ATUAL dos detalhes
        if (indicatorData.details && indicatorData.details["VALOR ATUAL"] !== undefined) {
            const valorAtual = indicatorData.details["VALOR ATUAL"];
            if (valorAtual !== null && valorAtual !== undefined) {
                return {
                    value: valorAtual,
                    year: new Date().getFullYear()
                };
            }
        }

        // Prioridade 2: Último valor histórico (tipo_dado: VALOR)
        if (indicatorData.history && indicatorData.history.length > 0) {
            // Filtrar apenas valores, não metas
            const valoresHistoricos = indicatorData.history.filter(item => 
                item.tipo_dado === 'VALOR' || item.tipo_dado === undefined
            );
            
            if (valoresHistoricos.length > 0) {
                const sortedHistory = [...valoresHistoricos].sort((a, b) => b.year - a.year);
                const latest = sortedHistory[0];

                if (latest.value !== null && latest.value !== undefined) {
                    return {
                        value: latest.value,
                        year: latest.year
                    };
                }
            }
        }

        // Prioridade 3: Tentar extrair de outros campos
        if (indicatorData.details) {
            for (let key in indicatorData.details) {
                const val = indicatorData.details[key];
                if (typeof val === 'number' && !isNaN(val) && key !== '#') {
                    return {
                        value: val,
                        year: new Date().getFullYear()
                    };
                }
            }
        }

        // Fallback: retornar zero
        return {
            value: 0,
            year: new Date().getFullYear()
        };
    }

    function groupDataByIndicator(data) {
        const grouped = {};

        data.forEach(item => {
            const indicatorName = item.INDICADORES;
            if (!indicatorName) return;

            if (!grouped[indicatorName]) {
                grouped[indicatorName] = {
                    details: item,
                    history: [],
                    metas: [] // NOVO: array separado para metas
                };
            }

            // Adicionar histórico se for VALOR ou se não tiver tipo_dado definido
            if ((item.tipo_dado === 'VALOR' || item.tipo_dado === undefined) && 
                item.valor !== null && item.valor !== undefined) {
                if (item.ano && item.valor !== undefined) {
                    grouped[indicatorName].history.push({
                        year: item.ano,
                        value: item.valor,
                        tipo_dado: item.tipo_dado || 'VALOR'
                    });
                }
            }
            
            // NOVO: Adicionar metas se tipo_dado for META
            if (item.tipo_dado === 'META' && item.valor !== null && item.valor !== undefined) {
                if (item.ano && item.valor !== undefined) {
                    grouped[indicatorName].metas.push({
                        year: item.ano,
                        value: item.valor,
                        tipo_dado: 'META'
                    });
                }
            }

            if (item.SUPINTENDÊNCIA || item.OBJETIVO_ESTRATÉGICO) {
                grouped[indicatorName].details = { ...grouped[indicatorName].details, ...item };
            }
        });

        Object.keys(grouped).forEach(key => {
            // Ordenar histórico
            const historyMap = new Map();
            grouped[key].history.forEach(item => historyMap.set(item.year, item));
            grouped[key].history = Array.from(historyMap.values()).sort((a, b) => a.year - b.year);
            
            // Ordenar metas
            const metasMap = new Map();
            grouped[key].metas.forEach(item => metasMap.set(item.year, item));
            grouped[key].metas = Array.from(metasMap.values()).sort((a, b) => a.year - b.year);

            const currentValueInfo = getCurrentValue(grouped[key]);
            if (currentValueInfo) {
                grouped[key].currentValue = currentValueInfo.value;
                grouped[key].currentYear = currentValueInfo.year;
            }
        });

        return grouped;
    }

    // FUNÇÃO GERATEHYPOTHETICALGOALS CORRIGIDA - verifica primeiro se há metas no JSON
    function generateHypotheticalGoals(indicatorData) {
        // PRIMEIRO: Verificar se há metas definidas no JSON (tipo_dado: META)
        if (indicatorData.metas && indicatorData.metas.length > 0) {
            let meta2025 = null;
            let meta2026 = null;
            
            // Procurar metas para 2025 e 2026
            indicatorData.metas.forEach(meta => {
                if (meta.year === 2025) {
                    meta2025 = meta.value;
                } else if (meta.year === 2026) {
                    meta2026 = meta.value;
                }
            });
            
            // Se encontrou metas no JSON, retornar elas
            if (meta2025 !== null || meta2026 !== null) {
                return {
                    meta2025: meta2025,
                    meta2026: meta2026,
                    hasExplicitMeta: true // Flag para identificar que veio do JSON
                };
            }
        }
        
        // SEGUNDO: Se não há metas no JSON, calcular baseado no valor atual
        let currentValue = indicatorData.currentValue;

        // Se currentValue for null/undefined, tentar outras fontes
        if (currentValue === null || currentValue === undefined) {
            // Tentar usar o último valor histórico (apenas VALOR, não META)
            const valoresHistoricos = indicatorData.history ? 
                indicatorData.history.filter(item => item.tipo_dado === 'VALOR' || item.tipo_dado === undefined) : [];
            
            if (valoresHistoricos.length > 0) {
                const sortedHistory = [...valoresHistoricos].sort((a, b) => b.year - a.year);
                currentValue = sortedHistory[0].value;
            }
            // Se ainda não tiver valor, usar VALOR ATUAL (mesmo que seja 0)
            else if (indicatorData.details && indicatorData.details["VALOR ATUAL"] !== undefined) {
                currentValue = indicatorData.details["VALOR ATUAL"];
            }
            else {
                currentValue = 0;
            }
        }

        const polaridade = indicatorData.details?.POLARIDADE || '';
        const grandeza = indicatorData.details?.GRANDEZA || '';

        let meta2025, meta2026;

        if (polaridade.includes('Positiva') || polaridade.includes('⬆️') ||
            polaridade.includes('arrow_upward') || polaridade.toString().toLowerCase().includes('positiva')) {
            meta2025 = currentValue * 1.1; // +10%
            meta2026 = currentValue * 1.2; // +20%
        } else if (polaridade.includes('Negativa') || polaridade.includes('⬇️') ||
                   polaridade.includes('arrow_downward') || polaridade.toString().toLowerCase().includes('negativa')) {
            meta2025 = currentValue * 0.9; // -10%
            meta2026 = currentValue * 0.8; // -20%
        } else {
            // Fallback para polaridade positiva
            meta2025 = currentValue * 1.1;
            meta2026 = currentValue * 1.2;
        }

        // FORMATAR COM 1 CASA DECIMAL
        if (grandeza === '%') {
            meta2025 = Math.round(meta2025 * 1000) / 1000; // 3 casas para arredondamento
            meta2026 = Math.round(meta2026 * 1000) / 1000;
        } else {
            // Para números, arredondar para 1 casa decimal
            meta2025 = Math.round(meta2025 * 10) / 10;
            meta2026 = Math.round(meta2026 * 10) / 10;
        }

        // Calcular referência máxima (maior valor da série histórica - apenas VALORES)
        const valoresHistoricos = indicatorData.history ? 
            indicatorData.history.filter(item => item.tipo_dado === 'VALOR' || item.tipo_dado === undefined) : [];
        const historyValues = valoresHistoricos.map(h => h.value);
        const max_ref = historyValues.length > 0 ? Math.max(...historyValues) : currentValue;

        return {
            meta2025: meta2025,
            meta2026: meta2026,
            max_ref: max_ref,
            hasExplicitMeta: false // Flag para identificar que foi calculada
        };
    }

    function toggleDropdown() {
        const dropdown = document.getElementById('indicators-dropdown-list');
        dropdown.classList.toggle('show');
    }

    function closeDropdown() {
        const dropdown = document.getElementById('indicators-dropdown-list');
        dropdown.classList.remove('show');
    }

    function loadIndicatorsDropdown(groupedData, currentIndicator) {
        const dropdownList = document.getElementById('indicators-dropdown-list');

        if (!groupedData || Object.keys(groupedData).length === 0) {
            dropdownList.innerHTML = '<div class="dropdown-item"><div class="indicator-name">Nenhum indicador encontrado</div></div>';
            return;
        }

        dropdownList.innerHTML = '';

        Object.entries(groupedData).forEach(([name, data]) => {
            const isCurrent = name === currentIndicator;

            const item = document.createElement('div');
            item.className = `dropdown-item ${isCurrent ? 'current' : ''}`;
            item.onclick = () => {
                if (!isCurrent) {
                    navigate(`?indicador=${encodeURIComponent(name)}`);
                }
                closeDropdown();
            };

            const statusClass = getStatusClass(data.details.Status);
            const displayStatus = normalizeStatus(data.details.Status);

            const displayValue = data.currentValue !== null && data.currentValue !== undefined ?
                formatValue(data.currentValue, data.details.GRANDEZA, 1) : 'N/A'; // 1 casa decimal

            item.innerHTML = `
                <div class="indicator-name">${data.details['#'] || '-'} - ${name}</div>
                <div style="display: flex; align-items: center;">
                    <div class="indicator-value">${displayValue}</div>
                    <div class="indicator-status ${statusClass}">${displayStatus}</div>
                </div>
            `;

            if (isCurrent) {
                item.style.backgroundColor = '#e3f2fd';
                item.style.fontWeight = '600';
            }

            dropdownList.appendChild(item);
        });
    }

    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('indicators-dropdown-list');
        const button = document.querySelector('.dropdown-button');
        if (button && dropdown && !button.contains(event.target) && !dropdown.contains(event.target)) {
            closeDropdown();
        }
    });

    function loadIndicatorDetails() {
        const data = loadData();
        const groupedData = groupDataByIndicator(data);

        const defaultIndicatorName = Object.keys(groupedData)[0];

        const params = getUrlParams();
        let indicatorName = decodeURIComponent(params.indicador || defaultIndicatorName);

        if (!params.indicador && Object.keys(groupedData).length > 0) {
            indicatorName = defaultIndicatorName;
            const newUrl = `?indicador=${encodeURIComponent(defaultIndicatorName)}`;
            window.history.replaceState(null, null, newUrl);
        }

        if (!indicatorName || !groupedData[indicatorName]) {
            document.getElementById('indicator-name').textContent = 'Indicador não encontrado';
            document.getElementById('indicator-description').textContent = 'O indicador selecionado não foi encontrado na base de dados';
            loadIndicatorsDropdown(groupedData, indicatorName);
            return;
        }

        const indicatorData = groupedData[indicatorName];
        loadIndicatorsDropdown(groupedData, indicatorName);

        const details = indicatorData.details;
        const history = indicatorData.history.sort((a, b) => a.year - b.year);
        const goals = generateHypotheticalGoals(indicatorData);

        // ATUALIZAÇÃO DA POLARIDADE
        const polarityElement = document.getElementById('detail-polaridade');
        polarityElement.innerHTML = '';

        const polaridade = (details.POLARIDADE || '').toString().trim();

        if (polaridade.includes('⬆️') || polaridade.includes('Positiva') ||
            polaridade.includes('arrow_upward') || polaridade.includes('+') ||
            polaridade.toLowerCase().includes('positiva')) {

            const icon = document.createElement('span');
            icon.className = 'material-symbols-outlined';
            icon.style.cssText = 'color: var(--color-positive); font-size: 24px; vertical-align: middle;';
            icon.textContent = 'arrow_upward';
            polarityElement.appendChild(icon);

        } else if (polaridade.includes('⬇️') || polaridade.includes('Negativa') ||
                   polaridade.includes('arrow_downward') || polaridade.includes('-') ||
                   polaridade.toLowerCase().includes('negativa')) {

            const icon = document.createElement('span');
            icon.className = 'material-symbols-outlined';
            icon.style.cssText = 'color: var(--color-negative); font-size: 24px; vertical-align: middle;';
            icon.textContent = 'arrow_downward';
            polarityElement.appendChild(icon);

        } else {
            polarityElement.textContent = '--';
        }

        document.getElementById('indicator-name').textContent = details.INDICADORES;
        document.getElementById('indicator-description').textContent =
            `${details['OBJETIVO ESTRATÉGICO'] || 'Indicador'} (#${details['#'] || '-'})`;

        document.getElementById('detail-grandeza').textContent = details.GRANDEZA || '--';
        document.getElementById('detail-periodicidade').textContent = details['PERIODICIDADE DE MEDIÇÃO'] || '--';

        // METAS - usar valores do JSON se disponíveis, senão usar os calculados
        const meta2025Value = goals.meta2025 !== null && goals.meta2025 !== undefined ?
            formatValue(goals.meta2025, details.GRANDEZA, 1) : 'N/A'; // 1 casa decimal
        const meta2026Value = goals.meta2026 !== null && goals.meta2026 !== undefined ?
            formatValue(goals.meta2026, details.GRANDEZA, 1) : 'N/A'; // 1 casa decimal

        document.getElementById('meta-2025-value-box').textContent = meta2025Value;
        document.getElementById('meta-2026-value-box').textContent = meta2026Value;

        // Adicionar tooltip para mostrar fonte da meta
        const meta2025Element = document.querySelector('.meta-2025 .meta-value');
        const meta2026Element = document.querySelector('.meta-2026 .meta-value');
        
        if (meta2025Element && goals.hasExplicitMeta) {
            meta2025Element.title = 'Meta extraída do banco de dados';
        }
        if (meta2026Element && goals.hasExplicitMeta) {
            meta2026Element.title = 'Meta extraída do banco de dados';
        }

        // Adicionar estilo visual para destacar quando as metas são zero
        if (goals.meta2025 === 0) {
            document.querySelector('.meta-2025 .meta-value').style.color = 'var(--color-text-light)';
        }
        if (goals.meta2026 === 0) {
            document.querySelector('.meta-2026 .meta-value').style.color = 'var(--color-text-light)';
        }

        const statusCard = document.getElementById('status-card');
        const displayStatus = normalizeStatus(details.Status);
        document.getElementById('status-value').textContent = displayStatus || '--';

        const statusColor = getStatusColor(details.Status);
        statusCard.style.borderTop = `4px solid ${statusColor}`;
        document.getElementById('status-value').style.color = statusColor;

        document.getElementById('objetivo-estrategico').textContent = details['OBJETIVO ESTRATÉGICO'] || '--';
        document.getElementById('referencial-meta').textContent =
            details['REFERENCIAL DA META'] || 'Baseado em crescimento histórico';
        document.getElementById('formula-content').textContent = details.FÓRMULA || 'Fórmula não especificada';
        document.getElementById('fonte-dados').textContent = details['FONTE DOS DADOS'] || '--';
        document.getElementById('responsavel').textContent = details.SUPINTENDÊNCIA || '--';

        renderChart(history, details.GRANDEZA, indicatorData);
    }

    function renderChart(history, grandeza, indicatorData) {
        const chartSvg = document.getElementById('chart-svg');
        const dataPointsContainer = document.getElementById('data-points-container');
        const yAxisContainer = document.getElementById('y-axis-container');
        const xAxisLabelsContainer = document.getElementById('x-axis-labels-container');
        const gridLinesContainer = document.getElementById('grid-lines-container');
        const barValuesContainer = document.getElementById('bar-values-container');

        chartSvg.innerHTML = '';
        dataPointsContainer.innerHTML = '';
        yAxisContainer.innerHTML = '';
        xAxisLabelsContainer.innerHTML = '';
        gridLinesContainer.innerHTML = '';
        if (barValuesContainer) barValuesContainer.innerHTML = '';

        // Filtrar apenas dados do tipo VALOR para o gráfico (excluir metas)
        let chartData = history.filter(item => item.tipo_dado === 'VALOR' || item.tipo_dado === undefined);

        const currentYear = new Date().getFullYear();
        const hasCurrentYearInHistory = chartData.some(item => item.year === currentYear);

        if (indicatorData.currentValue !== null && indicatorData.currentValue !== undefined &&
            !hasCurrentYearInHistory && indicatorData.currentYear === currentYear) {
            chartData.push({
                year: currentYear,
                value: indicatorData.currentValue,
                isCurrent: true,
                tipo_dado: 'VALOR'
            });
        } else if (hasCurrentYearInHistory) {
            chartData = chartData.map(item => {
                if (item.year === currentYear) {
                    return { ...item, isCurrent: true };
                }
                return item;
            });
        }

        const sortedData = chartData.sort((a, b) => a.year - b.year);
        const dataCount = sortedData.length;

        if (dataCount === 0) {
            chartSvg.innerHTML = '<text x="50%" y="50%" text-anchor="middle" fill="#999" font-size="12px">Sem dados históricos</text>';
            return;
        }

        const values = sortedData.map(h => h.value);

        const minVal = Math.min(...values);
        const maxVal = Math.max(...values);
        const range = maxVal - minVal;
        const padding = range * 0.1 || (minVal === 0 ? 0.05 : minVal * 0.1);
        const yMin = Math.max(0, minVal - padding);
        const yMax = maxVal + padding;
        const yRange = yMax - yMin;
        const effectiveYRange = (yRange === 0) ? (yMax * 0.2 || 0.1) : yRange;
        const effectiveYMin = (yRange === 0) ? (yMin - effectiveYRange / 2) : yMin;

        function scaleY(value) {
            if (effectiveYRange === 0) return 50;
            return 100 - ((value - effectiveYMin) / effectiveYRange) * 100;
        }

        const totalWidth = 100;
        const leftMargin = 2;
        const rightMargin = 2;
        const usableWidth = totalWidth - (leftMargin + rightMargin);

        let barWidth;
        if (dataCount <= 3) {
            barWidth = 20;
        } else if (dataCount <= 5) {
            barWidth = 15;
        } else if (dataCount <= 8) {
            barWidth = 10;
        } else {
            barWidth = 8;
        }

        barWidth = Math.min(barWidth, usableWidth / dataCount * 0.9);

        const totalBarWidth = barWidth * dataCount;
        const availableSpace = usableWidth - totalBarWidth;
        const spacing = availableSpace / (dataCount + 1);

        chartSvg.setAttribute('width', '100%');
        chartSvg.setAttribute('height', '100%');
        chartSvg.setAttribute('viewBox', '0 0 100 100');
        chartSvg.setAttribute('preserveAspectRatio', 'none');

        sortedData.forEach((item, index) => {
            const xPositionPercent = leftMargin + spacing + (index * (barWidth + spacing));

            const yTop = scaleY(item.value);
            const yBase = scaleY(effectiveYMin);
            const height = Math.max(0.5, yBase - yTop);

            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('x', `${xPositionPercent}`);
            rect.setAttribute('y', `${yTop}`);
            rect.setAttribute('width', `${barWidth}`);
            rect.setAttribute('height', `${height}`);
            rect.setAttribute('rx', '0');

            if (item.isCurrent || (indicatorData.currentValue !== null && item.year === indicatorData.currentYear)) {
                rect.setAttribute('fill', 'var(--color-primary)');
                rect.setAttribute('class', 'chart-bar current');
            } else {
                rect.setAttribute('fill', 'var(--color-chart-line)');
                rect.setAttribute('class', 'chart-bar');
            }

            chartSvg.appendChild(rect);

            const barCenterPercent = xPositionPercent + (barWidth / 2);

            if (barValuesContainer) {
                const valueLabel = document.createElement('div');
                valueLabel.className = 'bar-value-label';

                valueLabel.style.left = `${barCenterPercent}%`;
                valueLabel.style.bottom = `${100 - yTop + 2}%`;

                valueLabel.textContent = formatValue(item.value, grandeza, 1); // 1 casa decimal

                if (item.isCurrent || (indicatorData.currentValue !== null && item.year === indicatorData.currentYear)) {
                    valueLabel.style.fontWeight = 'bold';
                    valueLabel.style.color = 'var(--color-primary)';
                    valueLabel.style.backgroundColor = 'rgba(255, 255, 255, 0.95)';
                    valueLabel.style.border = '1px solid var(--color-primary)';
                }

                barValuesContainer.appendChild(valueLabel);
            }

            const label = document.createElement('div');
            label.className = 'x-axis-bar-label';

            label.style.left = `${barCenterPercent}%`;
            label.textContent = item.year;

            if (item.isCurrent || (indicatorData.currentValue !== null && item.year === indicatorData.currentYear)) {
                label.style.fontWeight = 'bold';
                label.style.color = 'var(--color-primary)';
                label.style.backgroundColor = 'rgba(0, 61, 122, 0.15)';
                label.style.border = '1px solid var(--color-primary)';
            }

            xAxisLabelsContainer.appendChild(label);

            const point = document.createElement('div');
            point.className = 'data-point-placeholder';
            point.style.left = `${barCenterPercent}%`;
            point.style.top = `${yTop}%`;
            point.setAttribute('data-value', `${item.year}: ${formatValue(item.value, grandeza, 1)}`); // 1 casa decimal
            dataPointsContainer.appendChild(point);
        });

        const numLabels = 5;
        for (let i = 0; i < numLabels; i++) {
            const percentage = i / (numLabels - 1);
            const value = effectiveYMin + (1 - percentage) * effectiveYRange;
            const yPos = percentage * 100;

            const label = document.createElement('div');
            label.className = 'y-axis-label';
            label.style.top = `${yPos}%`;
            label.textContent = formatValue(value, grandeza, 1); // 1 casa decimal
            yAxisContainer.appendChild(label);

            if (i < numLabels - 1) {
                const gridLine = document.createElement('div');
                gridLine.className = 'grid-line';
                gridLine.style.top = `${yPos}%`;
                gridLinesContainer.appendChild(gridLine);
            }
        }
    }

    function redrawChartWithAlignment() {
        const data = loadData();
        const groupedData = groupDataByIndicator(data);
        const params = getUrlParams();
        const indicatorName = decodeURIComponent(params.indicador || Object.keys(groupedData)[0]);

        if (groupedData[indicatorName]) {
            const indicatorData = groupedData[indicatorName];

            setTimeout(() => {
                renderChart(indicatorData.history, indicatorData.details.GRANDEZA, indicatorData);
            }, 50);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const data = loadData();
        const groupedData = groupDataByIndicator(data);

        const defaultIndicatorName = Object.keys(groupedData)[0];

        const params = getUrlParams();
        let indicatorName = decodeURIComponent(params.indicador || defaultIndicatorName);

        if (!params.indicador && Object.keys(groupedData).length > 0) {
            const newUrl = `?indicador=${encodeURIComponent(indicatorName)}`;
            window.history.replaceState(null, null, newUrl);
        }

        loadIndicatorDetails();

        setTimeout(redrawChartWithAlignment, 100);

        window.addEventListener('resize', () => {
            setTimeout(redrawChartWithAlignment, 150);
        });
    });
    </script>

</body>
</html>