<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Indicador - Painel de Monitoramento</title>
    
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --color-primary: #003d7a;
            --color-secondary: #0074d9;
            --color-chart-line: #2196F3;
            --color-chart-area: #B3E5FC;
            --color-meta-2025: #9370db;
            --color-meta-2026: #87cefa;
            --color-hiperpositive: #00f729;
            --color-positive: #2e7d32;
            --color-negative: #c62828;
            --color-gray: #9e9e9e;
        }
        
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
        }
        
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        
        .chart-line {
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: all 0.3s ease;
        }
        
        .chart-point {
            transition: all 0.3s ease;
        }
        
        .chart-point:hover {
            r: 5;
            filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.2));
        }
        
        .chart-bar {
            transition: all 0.3s ease;
        }
        
        .chart-bar:hover {
            opacity: 0.8;
            transform: translateY(-2px);
        }
        
        .grid-line {
            stroke: #e5e7eb;
            stroke-width: 1;
            stroke-dasharray: 4 2;
        }
        
        .tooltip {
            transition: all 0.2s ease;
            pointer-events: none;
            z-index: 50;
        }
        
        .value-label {
            font-size: 10px;
            font-weight: 600;
            fill: #374151;
            text-anchor: middle;
            pointer-events: none;
            user-select: none;
        }
        
        /* Modal de navega√ß√£o */
        .indicator-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            backdrop-filter: blur(4px);
        }
        
        .indicator-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        /* Remove scrollbars */
        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        *::-webkit-scrollbar {
            display: none;
        }
        
        /* Text overflow handling */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .line-clamp-4 {
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .line-clamp-5 {
            display: -webkit-box;
            -webkit-line-clamp: 5;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Custom styles for responsive boxes */
        .dynamic-content-box {
            display: flex;
            flex-direction: column;
        }
        
        .dynamic-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .dynamic-title {
            flex-shrink: 0;
            padding-top: 8px;
            border-top: 1px solid #f3f4f6;
        }
        
        /* Chart combo fix */
        .combo-chart-bar {
            opacity: 0.7;
        }
        
        .combo-chart-line {
            stroke-width: 2.5;
        }
        
        .notification-toast {
            opacity: 0;
            transform: translateX(100%);
        }
        
        /* Metas no gr√°fico */
        .meta-line {
            stroke-dasharray: 5, 5;
            stroke-width: 1.5;
        }
        
        /* Estilo para varia√ß√µes positivas/negativas */
        .positive-variation {
            color: #2e7d32;
            font-weight: bold;
        }
        
        .negative-variation {
            color: #c62828;
            font-weight: bold;
        }
        
        .neutral-variation {
            color: #6b7280;
            font-weight: bold;
        }
        
        /* Alturas fixas para os cards da coluna direita */
        .right-col-card {
            display: flex;
            flex-direction: column;
        }
        
        /* Garantir que o conte√∫do principal n√£o tenha scroll */
        .main-content {
            height: calc(100vh - 3rem);
            overflow: hidden;
        }
        
        /* Altura fixa para gr√°fico */
        .chart-container-wrapper {
            height: 60vh;
            min-height: 400px;
        }
        
        /* Remover qualquer padding/margin que cause overflow */
        .no-overflow {
            overflow: hidden !important;
        }
        
        /* Modal de login espec√≠fico */
        .login-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.7);
            z-index: 2000;
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        /* Novas classes para layout */
        .min-h-0 {
            min-height: 0 !important;
        }
        
        .flex-shrink-0 {
            flex-shrink: 0 !important;
        }
        
        .h-32 {
            height: 8rem !important;
        }
        /* Adicione no final da tag <style> */
        .text-xs-smaller {
            font-size: 0.7rem !important; /* 30% menor */
            line-height: 1.1 !important;
        }
        
        /* Estilos para o badge do tipo de indicador */
        #indicator-type-badge {
            padding: 2px 6px;
            border-radius: 4px;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
        }

        #indicator-type-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: inline-block;
        }

        /* Cores espec√≠ficas para tipos de indicador */
        .indicator-tatico-color {
            color: #f97316 !important;
        }

        .indicator-estrategico-color {
            color: #2196F3 !important;
        }

        /* Para os pontos do gr√°fico quando for t√°tico */
        .chart-point-tatico {
            fill: #f97316 !important;
        }

        .chart-bar-tatico {
            fill: #f97316 !important;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans h-screen overflow-hidden">
    <!-- MODAL DE LOGIN -->
    <div id="login-modal" class="login-modal">
        <div class="indicator-modal-content">
            <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md">
                <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 close-login">
                    <span class="material-symbols-outlined">close</span>
                </button>
                
                <div class="login-header text-center mb-6">
                    <img src="https://i.imgur.com/0wrUOlV.png" alt="SEEDUC" class="h-12 mx-auto mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Acesso √† Coleta de Dados</h3>
                    <p class="text-sm text-gray-600 mt-1">Fa√ßa login para solicitar dados dos indicadores</p>
                </div>
                
                <form id="login-form" class="login-form space-y-4">
                    <div class="form-group">
                        <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">E-mail institucional</label>
                        <input type="email" id="login-email" 
                               placeholder="seu.email@seeduc.rj.gov.br" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                               required>
                    </div>
                    
                    <div class="form-group">
                        <label for="login-senha" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                        <input type="password" id="login-senha" 
                               placeholder="Digite sua senha" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                               required>
                    </div>
                    
                    <div class="login-error text-red-600 text-sm hidden" id="login-error">
                        E-mail ou senha incorretos. Tente novamente.
                    </div>
                    
                    <button type="submit" class="w-full bg-blue-600 text-white py-2.5 px-4 rounded-md font-semibold hover:bg-blue-700 transition-colors flex items-center justify-center" id="login-button">
                        <span class="material-symbols-outlined mr-2" style="font-size: 18px;">login</span>
                        Entrar
                    </button>
                </form>
                
                <div class="login-footer text-center mt-6 pt-6 border-t border-gray-200">
                    <p class="text-xs text-gray-600">Apenas usu√°rios autorizados da SEEDUC podem acessar a coleta de dados.</p>
                    <p class="text-xs text-gray-500 mt-2">
                        <strong>Dados de teste:</strong><br>
                        E-mail: admin@seeduc.rj.gov.br<br>
                        Senha: seeduc123
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- CABE√áALHO COMPACTO -->
    <header class="bg-[#074f8a] text-white shadow-sm h-12 flex items-center">
        <div class="max-w-full mx-auto px-4 w-full">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <img src="https://i.imgur.com/0wrUOlV.png" alt="SEEDUC" class="h-8 w-auto">
                    <div class="text-sm font-bold">Boletim de Indicadores</div>
                </div>
                
                <nav class="flex items-center space-x-1">
                    <a href="index.html?page=home" class="px-2 py-1 text-xs font-medium rounded hover:bg-yellow-300 hover:text-gray-900 transition-colors">
                        Home
                    </a>
                    <a href="index.html?page=estrategicos" class="px-2 py-1 text-xs font-medium rounded hover:bg-yellow-300 hover:text-gray-900 transition-colors">
                        Estrat√©gicos
                    </a>
                    <a href="index.html?page=taticos" class="px-2 py-1 text-xs font-medium rounded hover:bg-yellow-300 hover:text-gray-900 transition-colors">
                        T√°ticos
                    </a>
                    <!-- BOT√ÉO LUPA PARA NAVEGA√á√ÉO -->
                    <button id="indicator-navigator-btn" class="ml-2 px-2 py-1 text-xs font-medium rounded bg-white/20 hover:bg-yellow-300 hover:text-gray-900 transition-colors flex items-center space-x-1">
                        <span class="material-symbols-outlined" style="font-size: 16px;">search</span>
                        <span class="hidden sm:inline">Navegar Indicadores</span>
                    </button>
                    <!-- BOT√ÉO DE COLETA DE DADOS -->
                    <button id="coleta-dados-btn" class="ml-2 px-2 py-1 text-xs font-medium rounded bg-[#2ecc71] text-white hover:bg-[#27ae60] transition-colors flex items-center space-x-1">
                        <span class="material-symbols-outlined" style="font-size: 16px;">data_check</span>
                        <span class="hidden sm:inline">Solicitar Dados</span>
                    </button>
                    
                    <!-- INFO DO USU√ÅRIO LOGADO -->
                    <div id="user-info-container" class="user-info ml-2 hidden px-2 py-1 bg-white/20 rounded text-xs items-center space-x-1">
                        <span class="material-symbols-outlined" style="font-size: 14px;">person</span>
                        <span id="user-email"></span>
                        <button class="logout-button text-xs hover:bg-white/20 px-1 rounded" onclick="logout()">Sair</button>
                    </div>
                </nav>
            </div>
        </div>
    </header>

    <!-- MODAL DE NAVEGA√á√ÉO DE INDICADORES -->
    <div id="indicator-modal" class="indicator-modal">
        <div class="indicator-modal-content">
            <div class="bg-white rounded-xl shadow-2xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-gray-800">Navegar entre Indicadores</h3>
                    <button id="close-modal-btn" class="text-gray-500 hover:text-gray-700">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <div id="indicators-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Indicadores ser√£o carregados aqui dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DE COLETA DE DADOS -->
    <div id="coleta-modal" class="indicator-modal">
        <div class="indicator-modal-content">
            <div class="bg-white rounded-xl shadow-2xl p-6 max-w-4xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-gray-800">Solicita√ß√£o de Coleta de Dados</h3>
                    <button id="close-coleta-btn" class="text-gray-500 hover:text-gray-700">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                
                <div id="coleta-content" class="space-y-6">
                    <!-- Conte√∫do ser√° carregado dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- CONTE√öDO PRINCIPAL - SEM ROLAGEM -->
    <main class="main-content no-overflow">
        <div class="h-full">
            <div class="grid grid-cols-1 lg:grid-cols-3 h-full gap-3 p-3">
                <!-- COLUNA ESQUERDA (2/3) -->
                <div class="lg:col-span-2 flex flex-col h-full">
                    <!-- CARD DO GR√ÅFICO - ALTURA FIXA -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 chart-container-wrapper flex-shrink-0">
                        <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-4">
                            <div class="mb-2 sm:mb-0">
                                <h1 id="indicator-name" class="text-lg font-bold text-gray-800 truncate">Carregando detalhes do indicador...</h1>
                                <div class="flex items-center space-x-1">
                                    <p class="text-xs text-gray-500">S√©rie Temporal do Indicador</p>
                                    <div id="indicator-type-badge" class="flex items-center space-x-1 hidden">
                                        <span id="indicator-type-dot" class="w-2 h-2 rounded-full"></span>
                                        <span id="indicator-type-text" class="text-xs font-medium"></span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- CONTROLES DISCRETOS DE VISUALIZA√á√ÉO -->
                            <div>
                                <div class="inline-flex rounded-lg border border-gray-200 p-0.5 bg-gray-50">
                                    <button id="chart-bar-btn" 
                                            class="chart-type-btn px-2 py-1 text-xs font-medium rounded-md transition-all duration-200 hover:bg-white hover:shadow-sm flex items-center space-x-1 active bg-white shadow-sm text-blue-600"
                                            data-type="bar">
                                        <span class="material-symbols-outlined" style="font-size: 14px;">bar_chart</span>
                                        <span class="hidden xs:inline">Barras</span>
                                    </button>
                                    <button id="chart-line-btn" 
                                            class="chart-type-btn px-2 py-1 text-xs font-medium rounded-md transition-all duration-200 hover:bg-white hover:shadow-sm flex items-center space-x-1"
                                            data-type="line">
                                        <span class="material-symbols-outlined" style="font-size: 14px;">show_chart</span>
                                        <span class="hidden xs:inline">Linhas</span>
                                    </button>
                                    <button id="chart-both-btn" 
                                            class="chart-type-btn px-2 py-1 text-xs font-medium rounded-md transition-all duration-200 hover:bg-white hover:shadow-sm flex items-center space-x-1"
                                            data-type="both">
                                        <span class="material-symbols-outlined" style="font-size: 14px;">stacked_line_chart</span>
                                        <span class="hidden xs:inline">Combo</span>
                                    </button>
                                </div>
                                
                                <!-- BOT√ÉO PARA MOSTRAR METAS NO GR√ÅFICO -->
                                <div class="mt-2 flex items-center space-x-2">
                                    <label class="flex items-center space-x-1 cursor-pointer">
                                        <input type="checkbox" id="show-metas-checkbox" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                        <span class="text-xs text-gray-600">Mostrar metas</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- √ÅREA DO GR√ÅFICO - FLEX√çVEL MAS COM ALTURA CONTROLADA -->
                        <div class="h-[calc(100%-60px)] relative">
                            <div id="chart-container" class="absolute inset-0">
                                <svg id="chart-svg" class="w-full h-full"></svg>
                                <div id="tooltip" class="tooltip absolute hidden bg-gray-900 text-white text-xs rounded-lg py-1.5 px-2 shadow-lg"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- DETALHES E METAS/VARIA√á√ïES - ALTURA FIXA -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3 flex-shrink-0">
                        <!-- DETALHES DO INDICADOR -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-3 text-center h-32">
                            <h3 class="text-xs font-semibold text-gray-700 mb-2">Detalhes do Indicador</h3>
                            <div class="grid grid-cols-3 gap-2 h-3/4">
                                <div class="text-center p-2 bg-gray-50 rounded-lg flex flex-col justify-center">
                                    <div id="detail-polaridade" class="text-xl mb-1 flex justify-center">--</div>
                                    <div class="text-xs text-gray-500 uppercase tracking-wide">Polaridade</div>
                                </div>
                                <div class="text-center p-2 bg-gray-50 rounded-lg flex flex-col justify-center">
                                    <div id="detail-grandeza" class="text-sm font-semibold text-gray-800 mb-1">--</div>
                                    <div class="text-xs text-gray-500 uppercase tracking-wide">Grandeza</div>
                                </div>
                                <div class="text-center p-2 bg-gray-50 rounded-lg flex flex-col justify-center">
                                    <div id="detail-periodicidade" class="text-sm font-semibold text-gray-800 mb-1">--</div>
                                    <div class="text-xs text-gray-500 uppercase tracking-wide">Periodicidade</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- METAS OU VARIA√á√ïES -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-3 text-center h-32">
                            <h3 id="metas-var-title" class="text-xs font-semibold text-gray-700 mb-2">Metas</h3>
                            <div class="grid grid-cols-2 gap-2 h-3/4">
                                <div id="box-variacao-1" class="p-1 rounded-lg border-l-3 border-purple-500 bg-purple-50 flex flex-col justify-center items-center text-center">
                                    <div id="meta-2025-value-box" class="text-sm font-bold text-gray-800 mb-1">N/A</div>
                                    <div id="label-variacao-1" class="text-xs text-gray-500 uppercase tracking-wide">Meta 2025</div>
                                </div>
                                <div id="box-variacao-2" class="p-1 rounded-lg border-l-3 border-blue-400 bg-blue-50 flex flex-col justify-center items-center text-center">
                                    <div id="meta-2026-value-box" class="text-sm font-bold text-gray-800 mb-1">N/A</div>
                                    <div id="label-variacao-2" class="text-xs text-gray-500 uppercase tracking-wide">Meta 2026</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- COLUNA DIREITA (1/3) -->
                <div class="flex flex-col h-full min-h-0">
                    <!-- STATUS -->
                    <div id="status-card" class="bg-white rounded-xl shadow-sm border-t-4 border-gray-400 p-3 h-20 mb-3 flex-shrink-0">
                        <div class="flex-1 flex items-center justify-center">
                            <div id="status-value" class="text-lg font-bold text-gray-800">--</div>
                        </div>
                        <div class="text-xs text-gray-500 uppercase tracking-wide pt-2 border-t border-gray-100 text-center">Status</div>
                    </div>
                    
                    <!-- OBJETIVO ESTRAT√âGICO -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-3 mb-3 flex flex-col flex-1 min-h-0">
                        <div id="objetivo-estrategico" class="flex-1 flex items-center justify-center text-center min-h-0">
                            <div class="flex flex-col items-center justify-center w-full px-2">
                                <div id="objetivo-icon" class="mb-1"></div>
                                <div id="objetivo-texto" class="w-full text-xs text-gray-700 line-clamp-2">Selecione um indicador para ver os detalhes completos</div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 uppercase tracking-wide pt-1 border-t border-gray-100 text-center flex-shrink-0">Objetivo Estrat√©gico</div>
                    </div>
                    
                    <!-- REFERENCIAL DA META -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-3 mb-3 flex flex-col flex-1 min-h-0">
                        <div id="referencial-meta" class="flex-1 flex items-center justify-center text-center min-h-0">
                            <div class="flex flex-col items-center justify-center w-full">
                                <div class="w-full text-center text-xs-smaller text-gray-700 line-clamp-3 px-1">--</div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 uppercase tracking-wide pt-1 border-t border-gray-100 text-center flex-shrink-0">Referencial da Meta</div>
                    </div>
                    
                    <!-- F√ìRMULA -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-3 mb-3 flex flex-col flex-1 min-h-0">
                        <div id="formula-content" class="flex-1 flex items-center justify-center text-center min-h-0">
                            <div class="flex flex-col items-center justify-center w-full">
                                <div class="w-full text-center text-xs-smaller text-gray-700 line-clamp-4">--</div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 uppercase tracking-wide pt-1 border-t border-gray-100 text-center flex-shrink-0">F√≥rmula</div>
                    </div>
                    
                    <!-- FONTE E RESPONS√ÅVEL -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-3 h-24 flex-shrink-0">
                        <div class="grid grid-cols-2 gap-2 h-full">
                            <div class="text-center flex flex-col justify-center items-center space-y-1">
                                <div id="fonte-dados" class="text-xs font-semibold text-gray-800 line-clamp-2 leading-tight px-1">--</div>
                                <div class="text-xs text-gray-500 uppercase tracking-wide border-t border-gray-100 pt-1 w-full">Fonte dos Dados</div>
                            </div>
                            <div class="text-center flex flex-col justify-center items-center space-y-1">
                                <div id="responsavel" class="text-xs font-semibold text-gray-800 line-clamp-2 leading-tight px-1">--</div>
                                <div class="text-xs text-gray-500 uppercase tracking-wide border-t border-gray-100 pt-1 w-full">Respons√°vel</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
    // URL DO SEU APPS SCRIPT
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyK7ZP6kE-yhep_vlu4jHmp4BfYMCNx4KUbMsmrNADAKVBtKyA0hJmc6Yoqv2_AAyLW/exec';
    
    // LISTA DE INDICADORES PARA COLETA (mantida igual)
    const INDICADORES_COLETA = [
        {
            id: 'PROF_FORMADOS_EE',
            nome: 'Profissionais formados na EE',
            formula: 'Œ£ Docentes e Profissionais com Forma√ß√£o na Educa√ß√£o Especial (120h)',
            periodicidade: 'Mensal',
            responsavel: 'SUPPEE'
        },
        {
            id: 'ESCOLAS_COM_AEE',
            nome: 'Escolas com salas de AEE',
            formula: '(N¬∫ de Escolas com salas AEE / N¬∫ total de Escolas ) * 100',
            periodicidade: 'Anual',
            responsavel: 'SUPPEE'
        },
        {
            id: 'NUM_RECURSOS_MULTIFUNC',
            nome: 'N√∫mero de recursos multifuncionais e tecnologias assistivas',
            formula: 'Œ£ Escolas com recursos multifuncionais',
            periodicidade: 'Semestral',
            responsavel: 'SUPPEE'
        },
        {
            id: 'AMPLIACAO_NAPS',
            nome: 'Amplia√ß√£o NAPS',
            formula: 'Œ£ n√∫mero de forma√ß√µes do NAPS',
            periodicidade: 'Semestral',
            responsavel: 'SUPPEE'
        }
    ];
    
    // Usu√°rios autorizados (igual ao c√≥digo anterior)
    const USUARIOS_AUTORIZADOS = [
        {
            email: 'admin@seeduc.rj.gov.br',
            senha: 'seeduc123',
            nome: 'Administrador SEEDUC'
        },
        {
            email: 'gestor@seeduc.rj.gov.br',
            senha: 'gestor123',
            nome: 'Gestor SEEDUC'
        },
        {
            email: 'analista@seeduc.rj.gov.br',
            senha: 'analista123',
            nome: 'Analista de Dados'
        },
        {
            email: 'ti@seeduc.rj.gov.br',
            senha: 'ti123',
            nome: 'Superintend√™ncia de TI'
        }
    ];
    
    // Estado de autentica√ß√£o
    let usuarioLogado = null;
    
    // VARI√ÅVEIS GLOBAIS
    let currentChartType = 'bar';
    let currentIndicatorData = null;
    let currentGrandeza = '';
    let allIndicatorsData = {};
    let showMetas = true;
    let currentIndicatorIsTatico = false;
    
    const colors = {
        primary: '#003d7a',
        chartLine: '#2196F3',
        current: '#003d7a',
        grid: '#e5e7eb',
        text: '#374151',
        textLight: '#6b7280',
        meta2025: '#9370db',
        meta2026: '#87cefa',
        positive: '#2e7d32',
        negative: '#c62828',
        neutral: '#6b7280'
    };
    
    // Array fixo de anos na ordem desejada (do mais antigo ao mais recente)
    const ANOS_DISPONIVEIS = [2019, 2021, 2022, 2023, 2024, 2025];
    
    // FUN√á√ïES B√ÅSICAS
    function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        return {
            indicador: params.get('indicador'),
            id: params.get('id')
        };
    }
    
    function formatNumberWithSeparators(numberString) {
        // Separa parte inteira e decimal
        const parts = numberString.split('.');
        let integerPart = parts[0];
        let decimalPart = parts.length > 1 ? parts[1] : '';
        
        // Adiciona separador de milhar (ponto)
        integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        
        // Junta com v√≠rgula decimal se houver parte decimal
        if (decimalPart) {
            // Remove zeros √† direita desnecess√°rios
            decimalPart = decimalPart.replace(/0+$/, '');
            if (decimalPart === '') {
                return integerPart;
            }
            return integerPart + ',' + decimalPart;
        }
        
        return integerPart;
    }
    
    function formatValue(value, grandeza, decimals = 1) {
        if (value === null || value === undefined || value === 0) return 'N/A';
        
        const isPercentage = grandeza === '%';
        
        // Se for porcentagem, converte para percentual
        if (isPercentage) {
            const percentValue = (value * 100).toFixed(decimals);
            return formatNumberWithSeparators(percentValue) + '%';
        }
        
        // Para n√∫meros normais
        if (typeof value === 'number') {
            // Fixa as casas decimais
            const fixedValue = value.toFixed(decimals);
            return formatNumberWithSeparators(fixedValue);
        }
        
        return value.toString();
    }
    
    function normalizeStatus(status) {
        if (!status) return 'Dados em Coleta';
        const normalizedStatus = status.toString().trim();
        if (normalizedStatus === 'Dados em coleta' || normalizedStatus === 'INDICADOR EM COLETA' ||
            normalizedStatus === 'Dados em Coleta' || normalizedStatus === 'Indicador em coleta') {
            return 'Dados em Coleta';
        }
        return normalizedStatus;
    }
    
    function getStatusColor(status) {
        const normalizedStatus = normalizeStatus(status);
        switch (normalizedStatus) {
            case 'Dentro do esperado': return '#00f729';
            case 'Meta 2025 alcan√ßada': return '#2e7d32';
            case 'Abaixo do esperado': return '#c62828';
            case 'Dados em Coleta': return '#9e9e9e';
            default: return '#6b7280';
        }
    }
    
    // FUN√á√ÉO PARA OBTER √çCONES DOS OBJETIVOS (igual ao index.html)
    function getObjectiveIcon(objName) {
        if (!objName) return '<span class="material-symbols-outlined text-gray-400">target</span>';
        
        switch(objName.trim()) {
            case "Acesso √† Educa√ß√£o":
                return '<span class="material-symbols-outlined text-blue-600">key</span>';
            case "Infraestrutura":
                return '<span class="material-symbols-outlined text-teal-600">foundation</span>';
            case "Perman√™ncia":
                return '<span class="material-symbols-outlined text-green-600">trending_up</span>';
            case "Aprendizagem Equitativa":
                return '<span class="material-symbols-outlined text-purple-600">interactive_space</span>';
            case "Educa√ß√£o Inclusiva e Acess√≠vel":
                return '<span class="material-symbols-outlined text-indigo-600">accessibility</span>';
            case "Regime de Colabora√ß√£o":
                return '<span class="material-symbols-outlined text-orange-600">handshake</span>';
            case "Sa√∫de e bem-estar":
                return '<span class="material-symbols-outlined text-pink-600">favorite</span>';
            case "Qualidade":
                return '<span class="material-symbols-outlined text-yellow-600">star</span>';
            case "Efici√™ncia Operacional":
                return '<span class="material-symbols-outlined text-cyan-600">settings</span>';
            case "Gest√£o de Pessoas":
                return '<span class="material-symbols-outlined text-red-600">groups</span>';
            case "Tecnologia e Inova√ß√£o":
                return '<span class="material-symbols-outlined text-blue-400">smart_toy</span>';
            case "Finan√ßas":
                return '<span class="material-symbols-outlined text-green-700">payments</span>';
            case "Comunica√ß√£o":
                return '<span class="material-symbols-outlined text-purple-400">campaign</span>';
            case "Sustentabilidade":
                return '<span class="material-symbols-outlined text-emerald-600">eco</span>';
            case "Seguran√ßa":
                return '<span class="material-symbols-outlined text-gray-700">shield</span>';
            case "Desenvolvimento Profissional":
                return '<span class="material-symbols-outlined text-blue-700">school</span>';
            case "Monitoramento e Avalia√ß√£o":
                return '<span class="material-symbols-outlined text-indigo-400">analytics</span>';
            case "Planejamento":
                return '<span class="material-symbols-outlined text-orange-400">calendar_month</span>';
            case "Gest√£o Estrat√©gica":
                return '<span class="material-symbols-outlined text-gray-800">strategy</span>';
            default:
                return '<span class="material-symbols-outlined text-gray-500">target</span>';
        }
    }
    
    // FUN√á√ÉO PARA FORMATAR VARIA√á√ÉO
    function formatVariacao(valor) {
        if (valor === null || valor === undefined || valor === 0) return 'N/A';
        const sinal = valor > 0 ? '+' : '';
        const valorFormatado = Math.abs(valor).toFixed(1);
        return `${sinal}${valorFormatado}%`;
    }
    
    // FUN√á√ÉO PARA OBTER CLASSE CSS PARA VARIA√á√ÉO
    function getVariacaoClass(valor) {
        if (valor === null || valor === undefined || valor === 0) return 'neutral-variation';
        return valor > 0 ? 'positive-variation' : 'negative-variation';
    }
    
    // FUN√á√ïES DE AUTENTICA√á√ÉO
    function verificarLoginParaColeta() {
        const usuarioSalvo = localStorage.getItem('usuarioLogado');
        
        if (usuarioSalvo) {
            usuarioLogado = JSON.parse(usuarioSalvo);
            atualizarInterfaceUsuario();
            abrirModalColeta();
        } else {
            abrirModalLogin();
        }
    }
    
    function abrirModalLogin() {
        const modal = document.getElementById('login-modal');
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
        
        document.getElementById('login-email').value = '';
        document.getElementById('login-senha').value = '';
        document.getElementById('login-error').classList.add('hidden');
        
        setTimeout(() => {
            document.getElementById('login-email').focus();
        }, 100);
    }
    
    function fecharModalLogin() {
        document.getElementById('login-modal').style.display = 'none';
        document.body.style.overflow = '';
    }
    
    function fazerLogin(event) {
        event.preventDefault();
        
        const email = document.getElementById('login-email').value.trim();
        const senha = document.getElementById('login-senha').value;
        const errorElement = document.getElementById('login-error');
        const loginButton = document.getElementById('login-button');
        
        loginButton.disabled = true;
        loginButton.innerHTML = '<span class="material-symbols-outlined mr-2">hourglass_empty</span> Verificando...';
        
        setTimeout(() => {
            const usuario = USUARIOS_AUTORIZADOS.find(user => 
                user.email === email && user.senha === senha
            );
            
            if (usuario) {
                usuarioLogado = {
                    email: usuario.email,
                    nome: usuario.nome,
                    dataLogin: new Date().toISOString()
                };
                
                localStorage.setItem('usuarioLogado', JSON.stringify(usuarioLogado));
                atualizarInterfaceUsuario();
                fecharModalLogin();
                abrirModalColeta();
                mostrarNotificacao(`Bem-vindo(a), ${usuario.nome}!`, 'success');
            } else {
                errorElement.classList.remove('hidden');
                errorElement.style.animation = 'none';
                setTimeout(() => {
                    errorElement.style.animation = 'shake 0.5s ease';
                }, 10);
            }
            
            loginButton.disabled = false;
            loginButton.innerHTML = '<span class="material-symbols-outlined mr-2">login</span> Entrar';
        }, 1000);
    }
    
    function logout() {
        if (confirm('Deseja realmente sair?')) {
            usuarioLogado = null;
            localStorage.removeItem('usuarioLogado');
            atualizarInterfaceUsuario();
            mostrarNotificacao('Voc√™ saiu do sistema.', 'info');
        }
    }
    
    function atualizarInterfaceUsuario() {
        const userInfoContainer = document.getElementById('user-info-container');
        const userEmailElement = document.getElementById('user-email');
        
        if (usuarioLogado) {
            userInfoContainer.classList.remove('hidden');
            userEmailElement.textContent = usuarioLogado.email.split('@')[0];
        } else {
            userInfoContainer.classList.add('hidden');
        }
    }
    
    function mostrarNotificacao(mensagem, tipo) {
        const notificacao = document.createElement('div');
        notificacao.className = 'fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg text-white font-medium text-sm flex items-center space-x-2 transition-all duration-300 transform translate-x-0 opacity-100';
        
        switch(tipo) {
            case 'success':
                notificacao.classList.add('bg-green-600');
                break;
            case 'error':
                notificacao.classList.add('bg-red-600');
                break;
            case 'info':
                notificacao.classList.add('bg-blue-600');
                break;
            default:
                notificacao.classList.add('bg-gray-800');
        }
        
        notificacao.innerHTML = `
            <span class="material-symbols-outlined text-lg">
                ${tipo === 'success' ? 'check_circle' : 
                  tipo === 'error' ? 'error' : 'info'}
            </span>
            <span>${mensagem}</span>
        `;
        
        document.body.appendChild(notificacao);
        
        setTimeout(() => {
            notificacao.classList.add('opacity-0', 'translate-x-full');
            setTimeout(() => {
                if (notificacao.parentNode) {
                    notificacao.parentNode.removeChild(notificacao);
                }
            }, 300);
        }, 3000);
    }
    
    function verificarSessaoAtiva() {
        const usuarioSalvo = localStorage.getItem('usuarioLogado');
        if (usuarioSalvo) {
            usuarioLogado = JSON.parse(usuarioSalvo);
            
            const dataLogin = new Date(usuarioLogado.dataLogin);
            const agora = new Date();
            const diferencaHoras = (agora - dataLogin) / (1000 * 60 * 60);
            
            if (diferencaHoras < 1) {
                atualizarInterfaceUsuario();
            } else {
                localStorage.removeItem('usuarioLogado');
                usuarioLogado = null;
            }
        }
    }
    
    // FUN√á√ïES DE CARREGAMENTO DE DADOS - AGORA BUSCA DO INDEX
    async function loadData() {
    try {
        console.log('üîÑ Tentando carregar dados do localStorage...');
        
        // Primeiro tenta do localStorage (mesmo usado pelo index.html)
        const storedData = localStorage.getItem('dashboardData');
        
        if (storedData) {
            console.log('‚úÖ Dados encontrados no localStorage');
            console.log('Tamanho dos dados:', storedData.length);
            
            const parsedData = JSON.parse(storedData);
            console.log('N√∫mero de registros:', parsedData.length);
            
            // Verificar se os dados cont√™m VARIACOES_RELATIVAS
            if (parsedData.length > 0) {
                console.log('üìä Primeiro indicador:', parsedData[0].INDICADORES);
                console.log('Tem VARIACOES_RELATIVAS?', !!parsedData[0].VARIACOES_RELATIVAS);
                console.log('Tem METAS?', !!parsedData[0].METAS);
                console.log('TIPO_INDICADOR:', parsedData[0].TIPO_INDICADOR);
            }
            
            return parsedData;
        } else {
            console.warn('‚ö†Ô∏è Nenhum dado encontrado no localStorage com chave "dashboardData"');
            
            // Lista todas as chaves do localStorage para debug
            console.log('Chaves dispon√≠veis no localStorage:');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                console.log(`Chave ${i}: ${key} (${value ? value.length : 0} chars)`);
            }
        }
        
        return [];
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar dados:', error);
        return [];
    }
}
    
    // FUN√á√ÉO MODIFICADA: Extrai hist√≥rico e atribui anos fixos
    function extractHistoryFromIndicator(indicator) {
    const history = [];
    
    // Mapeamento dos anos dispon√≠veis (do mais antigo ao mais recente)
    // VALOR_6 (mais antigo) ‚Üí 2019, VALOR_5 ‚Üí 2021, VALOR_4 ‚Üí 2022, 
    // VALOR_3 ‚Üí 2023, VALOR_2 ‚Üí 2024, VALOR_1 (mais recente) ‚Üí 2025
    
    const anoPorOrdem = {
        6: 2019, // Mais antigo
        5: 2021,
        4: 2022,
        3: 2023,
        2: 2024,
        1: 2025  // Mais recente
    };
    
    for (let i = 1; i <= 6; i++) {
        const valorKey = `VALOR_${i}`;
        const valorData = indicator[valorKey];
        
        // Verifica√ß√£o mais segura
        if (valorData && 
            typeof valorData === 'object' && 
            valorData.valor !== null && 
            valorData.valor !== undefined) {
            
            const anoCorrespondente = anoPorOrdem[i] || 2019 + (i - 1);
            
            history.push({
                periodo: `${anoCorrespondente}`, // Usar apenas o ano como per√≠odo
                valor: valorData.valor,
                referencia: `${anoCorrespondente}`, // Tamb√©m usar ano como refer√™ncia
                eh_data_base: valorData.eh_data_base,
                ordem_temporal: i, // Manter a ordem original
                mes: null, // N√£o usar informa√ß√µes mensais/semestrais
                ano: anoCorrespondente,
                trimestre: null,
                semestre: null
            });
        } else if (valorData !== null && valorData !== undefined) {
            // Caso o valor n√£o esteja no formato objeto
            const anoCorrespondente = anoPorOrdem[i] || 2019 + (i - 1);
            
            history.push({
                periodo: `${anoCorrespondente}`,
                valor: valorData,
                referencia: `${anoCorrespondente}`,
                eh_data_base: false,
                ordem_temporal: i,
                mes: null,
                ano: anoCorrespondente,
                trimestre: null,
                semestre: null
            });
        }
    }
    
    // ORDENA DO MAIS ANTIGO (menor ano) PARA O MAIS RECENTE (maior ano)
    return history.sort((a, b) => a.ano - b.ano);
}
    
    function groupDataByIndicator(data) {
        const grouped = {};
        
        data.forEach(indicator => {
            const indicatorName = indicator.INDICADORES;
            if (!indicatorName) return;
            
            if (!grouped[indicatorName]) {
                grouped[indicatorName] = {
                    details: indicator,
                    history: extractHistoryFromIndicator(indicator),
                    metas: indicator.METAS || {}
                };
            }
        });
        
        return grouped;
    }
    
    // FUN√á√ïES DE COLETA DE DADOS
    function abrirModalColeta() {
        if (!usuarioLogado) {
            abrirModalLogin();
            return;
        }
        
        const modal = document.getElementById('coleta-modal');
        const container = document.getElementById('coleta-content');
        
        container.innerHTML = criarConteudoColeta();
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
        
        document.querySelectorAll('.coleta-action-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const indicadorId = e.target.dataset.indicador;
                const acao = e.target.dataset.acao;
                if (acao === 'autorizar') abrirSolicitacaoTI(indicadorId);
                else if (acao === 'inserir') abrirFormularioColeta(indicadorId);
            });
        });
    }
    
    function criarConteudoColeta() {
        let userInfo = '';
        if (usuarioLogado) {
            userInfo = `
                <div class="bg-blue-50 p-3 rounded-lg mb-4 border-l-4 border-blue-500">
                    <div class="flex items-center space-x-2">
                        <span class="material-symbols-outlined text-blue-600" style="font-size: 18px;">person_check</span>
                        <div>
                            <div class="text-xs font-semibold text-blue-700">Usu√°rio logado</div>
                            <div class="text-xs text-gray-600">${usuarioLogado.email}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        let html = `
            ${userInfo}
            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-3">Solicite a coleta de dados para os indicadores abaixo:</p>
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <div class="bg-blue-50 p-3 rounded-lg">
                        <div class="flex items-center space-x-2">
                            <span class="material-symbols-outlined text-blue-600" style="font-size: 18px;">check_circle</span>
                            <span class="text-xs font-semibold text-blue-700">Autorizar TI</span>
                        </div>
                        <p class="text-xs text-gray-600 mt-1">Solicitar acesso aos dados via Superintend√™ncia de TI</p>
                    </div>
                    <div class="bg-orange-50 p-3 rounded-lg">
                        <div class="flex items-center space-x-2">
                            <span class="material-symbols-outlined text-orange-600" style="font-size: 18px;">edit</span>
                            <span class="text-xs font-semibold text-orange-700">Inserir Valor</span>
                        </div>
                        <p class="text-xs text-gray-600 mt-1">Inserir manualmente os dados dispon√≠veis</p>
                    </div>
                </div>
            </div>
            <div class="space-y-4">
        `;
        
        INDICADORES_COLETA.forEach(indicador => {
            html += `
                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="text-sm font-semibold text-gray-800">${indicador.nome}</h4>
                            <p class="text-xs text-gray-600 mt-1">${indicador.formula}</p>
                        </div>
                        <span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded">${indicador.periodicidade}</span>
                    </div>
                    <div class="flex justify-between items-center mt-3">
                        <span class="text-xs text-gray-500">Respons√°vel: ${indicador.responsavel}</span>
                        <div class="space-x-2">
                            <a href="#" class="coleta-action-link inline-block px-3 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors"
                               data-indicador="${indicador.id}" data-acao="autorizar">Autorizar TI</a>
                            <a href="#" class="coleta-action-link inline-block px-3 py-1 text-xs bg-orange-500 text-white rounded hover:bg-orange-600 transition-colors"
                               data-indicador="${indicador.id}" data-acao="inserir">Inserir Valor</a>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `</div>`;
        return html;
    }
    
    function abrirSolicitacaoTI(indicadorId) {
        const indicador = INDICADORES_COLETA.find(i => i.id === indicadorId);
        if (!indicador) return;
        const url = `${WEB_APP_URL}?acao=autorizar&indice=${indicadorId}&usuario=${encodeURIComponent(usuarioLogado.email)}`;
        window.open(url, '_blank');
        document.getElementById('coleta-modal').style.display = 'none';
        document.body.style.overflow = '';
        mostrarNotificacao('Solicita√ß√£o enviada para a Superintend√™ncia de TI', 'success');
    }
    
    function abrirFormularioColeta(indicadorId) {
        const indicador = INDICADORES_COLETA.find(i => i.id === indicadorId);
        if (!indicador) return;
        const url = `${WEB_APP_URL}?acao=editar&indice=${indicadorId}&usuario=${encodeURIComponent(usuarioLogado.email)}`;
        window.open(url, '_blank');
        document.getElementById('coleta-modal').style.display = 'none';
        document.body.style.overflow = '';
        mostrarNotificacao('Formul√°rio de coleta aberto', 'success');
    }
    
    // FUN√á√ÉO PARA CONFIGURAR A SE√á√ÉO DE METAS/VARIA√á√ïES
    function configurarMetasOuVariacoes(details) {
    console.log('üîç DEBUG: INICIANDO configurarMetasOuVariacoes');
    console.log('Nome do indicador:', details.INDICADORES);
    console.log('TIPO_INDICADOR:', details.TIPO_INDICADOR);
    console.log('Details completo:', details);
    
    // Determinar se √© indicador t√°tico - BUSCA MAIS AMPLA
    currentIndicatorIsTatico = (details['TIPO_INDICADOR'] || '').toUpperCase().includes('T√ÅTICOS') || 
                              (details['TIPO_INDICADOR'] || '').toUpperCase().includes('TATICOS') ||
                              (details['ORIGEM'] || '').toUpperCase().includes('T√ÅTICOS') ||
                              (details['ORIGEM'] || '').toUpperCase().includes('TATICOS') ||
                              (details['INDICADOR'] || '').toUpperCase().includes('T√ÅTICO') ||
                              (details['INDICADOR'] || '').toUpperCase().includes('TATICO');
    
    console.log('√â indicador t√°tico?', currentIndicatorIsTatico);
    
    const titleElement = document.getElementById('metas-var-title');
    const box1 = document.getElementById('box-variacao-1');
    const box2 = document.getElementById('box-variacao-2');
    const label1 = document.getElementById('label-variacao-1');
    const label2 = document.getElementById('label-variacao-2');
    const value1 = document.getElementById('meta-2025-value-box');
    const value2 = document.getElementById('meta-2026-value-box');
    
    if (currentIndicatorIsTatico) {
        console.log('üéØ TRATANDO COMO INDICADOR T√ÅTICO');
        console.log('VARIACOES_RELATIVAS dispon√≠veis?', details.VARIACOES_RELATIVAS);
        console.log('Keys do objeto:', Object.keys(details));
        
        titleElement.textContent = 'Varia√ß√µes';
        
        // BUSCA FLEX√çVEL DAS VARIA√á√ïES
        let variacaoAnoPassado = 0;
        let variacaoAnoRetrasado = 0;
        
        // Tenta m√∫ltiplas formas de encontrar as varia√ß√µes
        if (details.VARIACOES_RELATIVAS) {
            // Formato 1: Objeto com sub-objetos
            console.log('Encontrou VARIACOES_RELATIVAS:', details.VARIACOES_RELATIVAS);
            
            // Tenta acessar de diferentes formas
            if (details.VARIACOES_RELATIVAS.VARIACAO_ANO_PASSADO) {
                variacaoAnoPassado = details.VARIACOES_RELATIVAS.VARIACAO_ANO_PASSADO.valor || 
                                    details.VARIACOES_RELATIVAS.VARIACAO_ANO_PASSADO || 0;
                console.log('Varia√ß√£o ano passado encontrada:', variacaoAnoPassado);
            }
            
            if (details.VARIACOES_RELATIVAS.VARIACAO_ANO_RETRASADO) {
                variacaoAnoRetrasado = details.VARIACOES_RELATIVAS.VARIACAO_ANO_RETRASADO.valor || 
                                      details.VARIACOES_RELATIVAS.VARIACAO_ANO_RETRASADO || 0;
                console.log('Varia√ß√£o ano retrasado encontrada:', variacaoAnoRetrasado);
            }
        }
        
        // Se n√£o encontrou, tenta outras chaves
        if (variacaoAnoPassado === 0) {
            // Procura por varia√ß√µes em outras chaves
            const keys = Object.keys(details);
            const variacaoKeys = keys.filter(key => key.includes('VARIA') || key.includes('VARIAC'));
            console.log('Chaves de varia√ß√£o encontradas:', variacaoKeys);
            
            variacaoKeys.forEach(key => {
                console.log(`${key}:`, details[key]);
            });
        }
        
        console.log('VALORES FINAIS:');
        console.log('- Varia√ß√£o Ano Passado:', variacaoAnoPassado);
        console.log('- Varia√ß√£o Ano Retrasado:', variacaoAnoRetrasado);
        
        // Atualizar labels
        label1.textContent = 'Ano Anterior';
        label2.textContent = 'Ano Retrasado';
        
        // Atualizar valores com formata√ß√£o e cores
        value1.textContent = formatVariacao(variacaoAnoPassado);
        value2.textContent = formatVariacao(variacaoAnoRetrasado);
        
        // Aplicar classes de cor
        value1.className = `text-sm font-bold mb-1 ${getVariacaoClass(variacaoAnoPassado)}`;
        value2.className = `text-sm font-bold mb-1 ${getVariacaoClass(variacaoAnoRetrasado)}`;
        
        // Atualizar cores das bordas
        if (variacaoAnoPassado > 0) {
            box1.className = 'p-1 rounded-lg border-l-3 border-green-500 bg-green-50 flex flex-col justify-center items-center text-center';
        } else if (variacaoAnoPassado < 0) {
            box1.className = 'p-1 rounded-lg border-l-3 border-red-500 bg-red-50 flex flex-col justify-center items-center text-center';
        } else {
            box1.className = 'p-1 rounded-lg border-l-3 border-gray-400 bg-gray-50 flex flex-col justify-center items-center text-center';
        }
        
        if (variacaoAnoRetrasado > 0) {
            box2.className = 'p-1 rounded-lg border-l-3 border-green-400 bg-green-50 flex flex-col justify-center items-center text-center';
        } else if (variacaoAnoRetrasado < 0) {
            box2.className = 'p-1 rounded-lg border-l-3 border-red-400 bg-red-50 flex flex-col justify-center items-center text-center';
        } else {
            box2.className = 'p-1 rounded-lg border-l-3 border-gray-400 bg-gray-50 flex flex-col justify-center items-center text-center';
        }
        
    } else {
        console.log('üéØ TRATANDO COMO INDICADOR ESTRAT√âGICO');
        console.log('METAS dispon√≠veis?', details.METAS);
        console.log('Meta 2025:', details['META 2025']);
        console.log('Meta 2026:', details['META 2026']);
        
        titleElement.textContent = 'Metas';
        
        // Obter metas
        let meta2025 = 0;
        let meta2026 = 0;
        
        if (details.METAS) {
            meta2025 = details.METAS.META_2025?.valor || details['META 2025'] || null;
            meta2026 = details.METAS.META_2026?.valor || details['META 2026'] || null;
        } else {
            meta2025 = details['META 2025'] || null;
            meta2026 = details['META 2026'] || null;
        }
        
        console.log('Metas encontradas:', { meta2025, meta2026 });
        
        // Atualizar labels
        label1.textContent = 'Meta 2025';
        label2.textContent = 'Meta 2026';
        
        // Atualizar valores
        value1.textContent = formatValue(meta2025, details.GRANDEZA || '', 1);
        value2.textContent = formatValue(meta2026, details.GRANDEZA || '', 1);
        
        // Resetar classes de cor
        value1.className = 'text-sm font-bold text-gray-800 mb-1';
        value2.className = 'text-sm font-bold text-gray-800 mb-1';
        
        // Resetar cores das bordas
        box1.className = 'p-1 rounded-lg border-l-3 border-purple-500 bg-purple-50 flex flex-col justify-center items-center text-center';
        box2.className = 'p-1 rounded-lg border-l-3 border-blue-400 bg-blue-50 flex flex-col justify-center items-center text-center';
    }
}
    
    // FUN√á√ÉO PARA ATUALIZAR O BADGE DO TIPO DE INDICADOR
    function atualizarBadgeTipoIndicador(details) {
        const badgeContainer = document.getElementById('indicator-type-badge');
        const typeDot = document.getElementById('indicator-type-dot');
        const typeText = document.getElementById('indicator-type-text');
        const indicatorName = document.getElementById('indicator-name');
        
        // Determinar se √© t√°tico ou estrat√©gico
        const tipoIndicador = details.TIPO_INDICADOR || details['TIPO_INDICADOR'] || '';
        const isTatico = tipoIndicador.toUpperCase().includes('T√ÅTICO') || 
                        tipoIndicador.toUpperCase().includes('TATICO') ||
                        (details['#']?.toString() || '').length > 4;
        
        // Atualizar vari√°vel global
        currentIndicatorIsTatico = isTatico;
        
        if (isTatico) {
            // Indicador T√°tico - Laranja
            typeDot.style.backgroundColor = '#f97316';
            typeText.textContent = 'Indicador T√°tico';
            typeText.style.color = '#f97316';
            badgeContainer.classList.remove('hidden');
            
            // Atualizar cor do t√≠tulo
            indicatorName.style.color = '#ea580c';
            
            // Atualizar cor do gr√°fico para laranja
            colors.chartLine = '#f97316';
            colors.current = '#ea580c';
            
            // Atualizar bot√µes ativos
            document.querySelectorAll('.chart-type-btn.active').forEach(btn => {
                btn.style.color = '#f97316';
            });
        } else {
            // Indicador Estrat√©gico - Azul
            typeDot.style.backgroundColor = '#2196F3';
            typeText.textContent = 'Indicador Estrat√©gico';
            typeText.style.color = '#2196F3';
            badgeContainer.classList.remove('hidden');
            
            // Atualizar cor do t√≠tulo
            indicatorName.style.color = '#003d7a';
            
            // Resetar para cores azuis padr√£o
            colors.chartLine = '#2196F3';
            colors.current = '#003d7a';
            
            // Atualizar bot√µes ativos
            document.querySelectorAll('.chart-type-btn.active').forEach(btn => {
                btn.style.color = '#3b82f6';
            });
        }
    }
    
    // FUN√á√ïES PRINCIPAIS DO PAINEL
    function renderIndicatorMiniCards() {
        const container = document.getElementById('indicators-grid');
        container.innerHTML = '';
        
        if (Object.keys(allIndicatorsData).length === 0) {
            container.innerHTML = `
                <div class="col-span-1 md:col-span-2 lg:col-span-3 text-center py-8">
                    <span class="material-symbols-outlined text-gray-400 text-4xl mb-2">search_off</span>
                    <p class="text-gray-500">Nenhum indicador encontrado</p>
                    <p class="text-xs text-gray-400 mt-1">Volte ao painel principal para carregar os dados</p>
                </div>
            `;
            return;
        }
        
        Object.keys(allIndicatorsData).forEach(indicatorName => {
            const indicator = allIndicatorsData[indicatorName];
            const details = indicator.details;
            
            // Pega o valor mais recente (ano 2025)
            const currentValue = indicator.history.length > 0 
                ? indicator.history.find(h => h.ano === 2025)?.valor 
                : indicator.history[indicator.history.length - 1]?.valor;
            
            const status = normalizeStatus(details.Status);
            const statusColor = getStatusColor(details.Status);
            
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg border border-gray-200 p-4 hover:shadow-md transition-shadow cursor-pointer';
            card.dataset.indicator = indicatorName;
            
            card.innerHTML = `
                <div class="flex items-start justify-between mb-2">
                    <div class="text-xs text-gray-500 font-semibold">${details['#'] || ''}</div>
                    <div class="text-xs px-2 py-1 rounded-full" style="background-color: ${statusColor}20; color: ${statusColor};">
                        ${status}
                    </div>
                </div>
                <h4 class="text-sm font-semibold text-gray-800 mb-2 line-clamp-2">${indicatorName}</h4>
                <div class="text-xs text-gray-600 mb-3 line-clamp-1">${details['OBJETIVO ESTRAT√âGICO'] || ''}</div>
                <div class="flex justify-between items-center">
                    <div class="text-xs text-gray-500">
                        Valor atual: <span class="font-semibold">${formatValue(currentValue, details.GRANDEZA || '', 2)}</span>
                    </div>
                    <div class="text-xs text-gray-500">${details['PERIODICIDADE DE MEDI√á√ÉO'] || ''}</div>
                </div>
            `;
            
            card.addEventListener('click', () => {
                const url = new URL(window.location);
                url.searchParams.set('indicador', encodeURIComponent(indicatorName));
                window.location.href = url.toString();
            });
            
            container.appendChild(card);
        });
    }
    
    async function loadIndicatorDetails() {
        try {
            const data = await loadData();
            
            if (!data || data.length === 0) {
                document.getElementById('indicator-name').textContent = 'Nenhum dado encontrado';
                document.getElementById('objetivo-texto').textContent = 'Volte ao painel principal para carregar os dados';
                return;
            }
            
            const groupedData = groupDataByIndicator(data);
            allIndicatorsData = groupedData;
            
            const params = getUrlParams();
            let indicatorName = decodeURIComponent(params.indicador || '');
            
            // Se n√£o tem nome no URL, usa o primeiro indicador dispon√≠vel
            if (!indicatorName || !groupedData[indicatorName]) {
                indicatorName = Object.keys(groupedData)[0];
                if (indicatorName) {
                    // Atualiza o URL sem recarregar
                    const url = new URL(window.location);
                    url.searchParams.set('indicador', encodeURIComponent(indicatorName));
                    window.history.replaceState({}, '', url);
                }
            }
            
            if (!indicatorName || !groupedData[indicatorName]) {
                document.getElementById('indicator-name').textContent = 'Indicador n√£o encontrado';
                document.getElementById('objetivo-texto').textContent = 'Selecione um indicador v√°lido';
                return;
            }
            
            const indicatorData = groupedData[indicatorName];
            currentIndicatorData = indicatorData;
            const details = indicatorData.details;
            const history = indicatorData.history; // Agora vem ordenado por ano (2019, 2021, 2022, 2023, 2024, 2025)
            currentGrandeza = details.GRANDEZA || '';
            
            // Atualizar nome do indicador
            document.getElementById('indicator-name').textContent = details.INDICADORES;
            
            // Atualizar badge do tipo de indicador
            atualizarBadgeTipoIndicador(details);
            
            // Atualizar polaridade
            const polarityElement = document.getElementById('detail-polaridade');
            polarityElement.innerHTML = '';
            const polaridade = (details.POLARIDADE || '').toString().trim();
            if (polaridade.includes('‚¨ÜÔ∏è') || polaridade.toLowerCase().includes('positiva')) {
                const icon = document.createElement('span');
                icon.className = 'material-symbols-outlined';
                icon.style.cssText = 'color: #2e7d32; font-size: 20px;';
                icon.textContent = 'arrow_upward';
                polarityElement.appendChild(icon);
            } else if (polaridade.includes('‚¨áÔ∏è') || polaridade.toLowerCase().includes('negativa')) {
                const icon = document.createElement('span');
                icon.className = 'material-symbols-outlined';
                icon.style.cssText = 'color: #c62828; font-size: 20px;';
                icon.textContent = 'arrow_downward';
                polarityElement.appendChild(icon);
            } else {
                polarityElement.textContent = '--';
            }
            
            // Atualizar outros detalhes
            document.getElementById('detail-grandeza').textContent = details.GRANDEZA || '--';
            document.getElementById('detail-periodicidade').textContent = details['PERIODICIDADE DE MEDI√á√ÉO'] || '--';
            
            // Atualizar objetivo estrat√©gico COM √çCONE
            const objetivoEstrategico = details['OBJETIVO ESTRAT√âGICO'] || '--';
            const objetivoIcon = getObjectiveIcon(objetivoEstrategico);
            document.getElementById('objetivo-icon').innerHTML = objetivoIcon;
            document.getElementById('objetivo-texto').textContent = objetivoEstrategico;
            
            // Atualizar outras informa√ß√µes
            const referencialMeta = details['REFERENCIAL DA META'] || 'Baseado em crescimento hist√≥rico';
            const referencialElement = document.querySelector('#referencial-meta .w-full');
            if (referencialElement) {
                referencialElement.innerHTML = ''; // Limpa
                const span = document.createElement('span');
                span.className = 'text-xs-smaller text-gray-700 line-clamp-3 px-1';
                span.textContent = referencialMeta;
                referencialElement.appendChild(span);
            }

            const formula = details.F√ìRMULA || 'F√≥rmula n√£o especificada';
            const formulaElement = document.querySelector('#formula-content .w-full');
            if (formulaElement) {
                formulaElement.innerHTML = ''; // Limpa
                const span = document.createElement('span');
                span.className = 'text-xs-smaller text-gray-700 line-clamp-4 px-1';
                span.textContent = formula;
                formulaElement.appendChild(span);
            }
            
            document.getElementById('fonte-dados').textContent = details['FONTE DOS DADOS'] || '--';
            
            // Respons√°vel: usar SUPINTEND√äNCIA ou SUBSECRETARIA
            const responsavel = details.SUPINTEND√äNCIA || details.SUBSECRETARIA || '--';
            document.getElementById('responsavel').textContent = responsavel;
            
            // Configurar se√ß√£o de metas ou varia√ß√µes
            configurarMetasOuVariacoes(details);
            
            // Atualizar status
            const displayStatus = normalizeStatus(details.Status);
            document.getElementById('status-value').textContent = displayStatus || '--';
            const statusColor = getStatusColor(details.Status);
            document.getElementById('status-card').style.borderTopColor = statusColor;
            document.getElementById('status-value').style.color = statusColor;
            
            // Renderizar gr√°fico
            renderChart(history);
            
        } catch (error) {
            console.error('Erro ao carregar detalhes do indicador:', error);
            document.getElementById('indicator-name').textContent = 'Erro ao carregar dados';
            document.getElementById('objetivo-texto').textContent = 'Ocorreu um erro ao carregar os dados do indicador';
        }
    }
    
    function renderChart(history) {
        const svg = document.getElementById('chart-svg');
        svg.innerHTML = '';
        
        const container = document.getElementById('chart-container');
        const width = container.clientWidth;
        const height = container.clientHeight;
        
        if (history.length === 0) {
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', '50%');
            text.setAttribute('y', '50%');
            text.setAttribute('text-anchor', 'middle');
            text.setAttribute('fill', '#9ca3af');
            text.setAttribute('font-size', '12px');
            text.textContent = 'Sem dados temporais';
            svg.appendChild(text);
            return;
        }
        
        // Preparar dados para o gr√°fico - AGORA V√äM ORDENADOS POR ANO (2019, 2021, 2022, 2023, 2024, 2025)
        const chartData = history.map(item => ({
            label: item.periodo || `Ano ${item.ano}`,
            value: item.valor,
            ano: item.ano,
            eh_data_base: item.eh_data_base,
            referencia: item.referencia
        }));
        
        const values = chartData.map(d => d.value);
        const minVal = Math.min(...values);
        const maxVal = Math.max(...values);
        
        // Incluir metas no c√°lculo do range apenas se for indicador estrat√©gico E mostrar metas estiver ativado
        let rangeMin = minVal;
        let rangeMax = maxVal;
        
        if (showMetas && !currentIndicatorIsTatico && currentIndicatorData) {
            const details = currentIndicatorData.details;
            const meta2025 = details.METAS?.META_2025?.valor || details['META 2025'] || null;
            const meta2026 = details.METAS?.META_2026?.valor || details['META 2026'] || null;
            
            if (meta2025 !== null && meta2025 !== undefined) {
                rangeMin = Math.min(rangeMin, meta2025);
                rangeMax = Math.max(rangeMax, meta2025);
            }
            if (meta2026 !== null && meta2026 !== undefined) {
                rangeMin = Math.min(rangeMin, meta2026);
                rangeMax = Math.max(rangeMax, meta2026);
            }
        }
        
        const range = rangeMax - rangeMin;
        const padding = range * 0.20 || (rangeMin === 0 ? 0.15 : rangeMin * 0.20);
        const yMin = Math.max(0, rangeMin - padding);
        const yMax = rangeMax + padding;
        const yRange = yMax - yMin;
        
        const margin = { top: 30, right: 40, bottom: 50, left: 60 };
        const chartWidth = width - margin.left - margin.right;
        const chartHeight = height - margin.top - margin.bottom;
        
        // FUN√á√ïES DE ESCALA CORRIGIDAS
        const xScale = (index) => {
            if (chartData.length === 1) return margin.left + chartWidth / 2;
            const effectiveWidth = chartWidth * 0.85;
            const startOffset = chartWidth * 0.075;
            // Agora index 0 = 2019 (mais antigo, ESQUERDA), index √∫ltimo = 2025 (mais recente, DIREITA)
            return margin.left + startOffset + (index / (chartData.length - 1)) * effectiveWidth;
        };
        
        // CORRE√á√ÉO DO EIXO Y: valores maiores ficam EM CIMA, menores EM BAIXO
        const yScale = (value) => {
            // value - yMin: qu√£o acima do m√≠nimo est√°
            // (value - yMin) / yRange: propor√ß√£o (0 a 1)
            // chartHeight * (1 - propor√ß√£o): invertido para valores maiores ficarem em cima
            const proportion = (value - yMin) / yRange;
            return margin.top + (chartHeight * (1 - proportion));
        };
        
        // Desenhar linhas de grade (corrigido para eixo Y invertido)
        for (let i = 0; i <= 5; i++) {
            const proportion = i / 5;
            const y = margin.top + (chartHeight * proportion); // Agora 0 = topo, 1 = base
            const value = yMax - (proportion * yRange); // Valor correspondente (maior no topo)
            
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', margin.left);
            line.setAttribute('y1', y);
            line.setAttribute('x2', width - margin.right);
            line.setAttribute('y2', y);
            line.setAttribute('class', 'grid-line');
            svg.appendChild(line);
            
            const yLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            yLabel.setAttribute('x', margin.left - 15);
            yLabel.setAttribute('y', y);
            yLabel.setAttribute('text-anchor', 'end');
            yLabel.setAttribute('dominant-baseline', 'middle');
            yLabel.setAttribute('fill', colors.textLight);
            yLabel.setAttribute('font-size', '11px');
            yLabel.setAttribute('font-weight', '500');
            yLabel.textContent = formatValue(value, currentGrandeza, 1);
            svg.appendChild(yLabel);
        }
        
        // Desenhar metas se ativadas e se for indicador estrat√©gico
        if (showMetas && !currentIndicatorIsTatico && currentIndicatorData) {
            const details = currentIndicatorData.details;
            const meta2025 = details.METAS?.META_2025?.valor || details['META 2025'] || null;
            const meta2026 = details.METAS?.META_2026?.valor || details['META 2026'] || null;
            
            // Meta 2025
            if (meta2025 !== null && meta2025 !== undefined) {
                const yMeta2025 = yScale(meta2025);
                
                const metaLine2025 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                metaLine2025.setAttribute('x1', margin.left);
                metaLine2025.setAttribute('y1', yMeta2025);
                metaLine2025.setAttribute('x2', width - margin.right);
                metaLine2025.setAttribute('y2', yMeta2025);
                metaLine2025.setAttribute('class', 'meta-line');
                metaLine2025.setAttribute('stroke', colors.meta2025);
                metaLine2025.setAttribute('stroke-width', '1.5');
                svg.appendChild(metaLine2025);
                
                const metaLabel2025 = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                metaLabel2025.setAttribute('x', width - margin.right + 5);
                metaLabel2025.setAttribute('y', yMeta2025);
                metaLabel2025.setAttribute('text-anchor', 'start');
                metaLabel2025.setAttribute('dominant-baseline', 'middle');
                metaLabel2025.setAttribute('fill', colors.meta2025);
                metaLabel2025.setAttribute('font-size', '10px');
                metaLabel2025.setAttribute('font-weight', '600');
                metaLabel2025.textContent = `Meta 2025: ${formatValue(meta2025, currentGrandeza, 1)}`;
                svg.appendChild(metaLabel2025);
            }
            
            // Meta 2026
            if (meta2026 !== null && meta2026 !== undefined) {
                const yMeta2026 = yScale(meta2026);
                
                const metaLine2026 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                metaLine2026.setAttribute('x1', margin.left);
                metaLine2026.setAttribute('y1', yMeta2026);
                metaLine2026.setAttribute('x2', width - margin.right);
                metaLine2026.setAttribute('y2', yMeta2026);
                metaLine2026.setAttribute('class', 'meta-line');
                metaLine2026.setAttribute('stroke', colors.meta2026);
                metaLine2026.setAttribute('stroke-width', '1.5');
                svg.appendChild(metaLine2026);
                
                const metaLabel2026 = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                metaLabel2026.setAttribute('x', width - margin.right + 5);
                metaLabel2026.setAttribute('y', yMeta2026);
                metaLabel2026.setAttribute('text-anchor', 'start');
                metaLabel2026.setAttribute('dominant-baseline', 'middle');
                metaLabel2026.setAttribute('fill', colors.meta2026);
                metaLabel2026.setAttribute('font-size', '10px');
                metaLabel2026.setAttribute('font-weight', '600');
                metaLabel2026.textContent = `Meta 2026: ${formatValue(meta2026, currentGrandeza, 1)}`;
                svg.appendChild(metaLabel2026);
            }
        }
        
        // Criar pontos para o gr√°fico (ordenados corretamente: 2019 √† esquerda, 2025 √† direita)
        const points = chartData.map((d, i) => ({
            x: xScale(i),
            y: yScale(d.value),
            value: d.value,
            label: d.label,
            ano: d.ano,
            eh_data_base: d.eh_data_base,
            referencia: d.referencia
        }));
        
        // Desenhar barras (se bar ou both) - CORRIGIDA ALTURA DA BARRA
        if (currentChartType === 'bar' || currentChartType === 'both') {
            const barWidth = Math.min(30, (chartWidth * 0.85) / chartData.length * 0.7);
            
            points.forEach((point, i) => {
                const barX = point.x - barWidth / 2;
                // ALTURA CORRIGIDA: da linha de base (height - margin.bottom) at√© o ponto Y
                const barHeight = (height - margin.bottom) - point.y;
                const barY = point.y; // Topo da barra no ponto Y
                
                const bar = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                bar.setAttribute('x', barX);
                bar.setAttribute('y', barY);
                bar.setAttribute('width', barWidth);
                bar.setAttribute('height', barHeight);
                bar.setAttribute('class', currentChartType === 'both' ? 'combo-chart-bar' : 'chart-bar');
                bar.setAttribute('fill', point.eh_data_base ? colors.current : colors.chartLine);
                if (currentChartType === 'both') bar.setAttribute('opacity', '0.6');
                bar.setAttribute('rx', '2');
                bar.setAttribute('data-label', point.label);
                bar.setAttribute('data-value', point.value);
                bar.setAttribute('data-ano', point.ano);
                
                // Adicionar r√≥tulo de valor no TOPO da barra
                if (barHeight > 25) {
                    const valueLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    valueLabel.setAttribute('x', point.x);
                    valueLabel.setAttribute('y', point.y - 10); // Acima da barra
                    valueLabel.setAttribute('text-anchor', 'middle');
                    valueLabel.setAttribute('class', 'value-label');
                    valueLabel.setAttribute('font-size', '10px');
                    valueLabel.textContent = formatValue(point.value, currentGrandeza, 2);
                    svg.appendChild(valueLabel);
                }
                
                // Eventos de hover
                bar.addEventListener('mouseenter', (e) => {
                    bar.style.opacity = currentChartType === 'both' ? '0.8' : '0.8';
                    showTooltip(e, point.label, point.value);
                });
                
                bar.addEventListener('mouseleave', () => {
                    bar.style.opacity = currentChartType === 'both' ? '0.6' : '1';
                    hideTooltip();
                });
                
                svg.appendChild(bar);
            });
        }
        
        // Desenhar linha (se line ou both)
        if (currentChartType === 'line' || currentChartType === 'both') {
            let pathData = '';
            points.forEach((point, i) => {
                pathData += (i === 0 ? `M ${point.x} ${point.y}` : ` L ${point.x} ${point.y}`);
            });
            
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            line.setAttribute('d', pathData);
            line.setAttribute('class', currentChartType === 'both' ? 'combo-chart-line' : 'chart-line');
            line.setAttribute('fill', 'none');
            line.setAttribute('stroke', colors.chartLine);
            line.setAttribute('stroke-width', currentChartType === 'both' ? '2.5' : '2');
            svg.appendChild(line);
            
            // Adicionar pontos na linha
            points.forEach(point => {
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', point.x);
                circle.setAttribute('cy', point.y);
                circle.setAttribute('r', '4');
                circle.setAttribute('class', 'chart-point');
                circle.setAttribute('fill', point.eh_data_base ? colors.current : colors.chartLine);
                circle.setAttribute('stroke', '#ffffff');
                circle.setAttribute('stroke-width', '2');
                circle.setAttribute('data-label', point.label);
                circle.setAttribute('data-value', point.value);
                circle.setAttribute('data-ano', point.ano);
                
                // Adicionar r√≥tulo de valor se n√£o tiver barra ou se for tipo linha
                if (currentChartType === 'line') {
                    const valueLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    valueLabel.setAttribute('x', point.x);
                    valueLabel.setAttribute('y', point.y - 15); // Acima do ponto
                    valueLabel.setAttribute('text-anchor', 'middle');
                    valueLabel.setAttribute('class', 'value-label');
                    valueLabel.setAttribute('font-size', '10px');
                    valueLabel.textContent = formatValue(point.value, currentGrandeza, 2);
                    svg.appendChild(valueLabel);
                }
                
                // Eventos de hover
                circle.addEventListener('mouseenter', (e) => {
                    circle.setAttribute('r', '5');
                    showTooltip(e, point.label, point.value);
                });
                
                circle.addEventListener('mouseleave', () => {
                    circle.setAttribute('r', '4');
                    hideTooltip();
                });
                
                svg.appendChild(circle);
            });
        }
        
        // Adicionar r√≥tulos do eixo X (ordenados corretamente: anos de 2019 a 2025)
        points.forEach((point, i) => {
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', point.x);
            text.setAttribute('y', height - margin.bottom / 2);
            text.setAttribute('text-anchor', 'middle');
            text.setAttribute('fill', colors.text);
            text.setAttribute('font-size', '11px');
            text.setAttribute('font-weight', point.eh_data_base ? 'bold' : '500');
            
            // Usar apenas o ano como label
            const displayLabel = point.ano.toString();
            
            text.textContent = displayLabel;
            svg.appendChild(text);
        });
        
        // Desenhar eixos
        const xAxisLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        xAxisLine.setAttribute('x1', margin.left);
        xAxisLine.setAttribute('y1', height - margin.bottom);
        xAxisLine.setAttribute('x2', width - margin.right);
        xAxisLine.setAttribute('y2', height - margin.bottom);
        xAxisLine.setAttribute('stroke', colors.grid);
        xAxisLine.setAttribute('stroke-width', '1.5');
        svg.appendChild(xAxisLine);
        
        const yAxisLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        yAxisLine.setAttribute('x1', margin.left);
        yAxisLine.setAttribute('y1', margin.top);
        yAxisLine.setAttribute('x2', margin.left);
        yAxisLine.setAttribute('y2', height - margin.bottom);
        yAxisLine.setAttribute('stroke', colors.grid);
        yAxisLine.setAttribute('stroke-width', '1.5');
        svg.appendChild(yAxisLine);
        
        // T√≠tulo do eixo Y
        const yAxisTitle = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        yAxisTitle.setAttribute('x', margin.left - 45);
        yAxisTitle.setAttribute('y', margin.top + chartHeight / 2);
        yAxisTitle.setAttribute('text-anchor', 'middle');
        yAxisTitle.setAttribute('transform', `rotate(-90, ${margin.left - 45}, ${margin.top + chartHeight / 2})`);
        yAxisTitle.setAttribute('fill', colors.textLight);
        yAxisTitle.setAttribute('font-size', '11px');
        yAxisTitle.setAttribute('font-weight', '500');
        yAxisTitle.textContent = currentGrandeza || 'Valor';
        svg.appendChild(yAxisTitle);
    }
    
    function showTooltip(event, label, value) {
        const tooltip = document.getElementById('tooltip');
        
        // Usa formata√ß√£o com 3 casas decimais para tooltips
        const formattedValue = formatValue(value, currentGrandeza, 3);
        
        tooltip.innerHTML = `<div class="font-semibold">${label}</div><div class="text-gray-300">${formattedValue}</div>`;
        tooltip.style.left = (event.offsetX + 15) + 'px';
        tooltip.style.top = (event.offsetY - 50) + 'px';
        tooltip.classList.remove('hidden');
    }
    
    function hideTooltip() {
        document.getElementById('tooltip').classList.add('hidden');
    }
    
    function changeChartType(type) {
        currentChartType = type;
        
        // Determinar cor baseada no tipo de indicador
        const activeColor = currentIndicatorIsTatico ? '#f97316' : '#3b82f6';
        
        document.querySelectorAll('.chart-type-btn').forEach(btn => {
            btn.classList.remove('active', 'bg-white', 'shadow-sm');
            btn.style.color = ''; // Resetar cor
            
            if (btn.dataset.type === type) {
                btn.classList.add('active', 'bg-white', 'shadow-sm');
                btn.style.color = activeColor;
            }
        });
        
        if (currentIndicatorData) {
            const history = currentIndicatorData.history;
            renderChart(history);
        }
    }
    
    // INICIALIZA√á√ÉO
    document.addEventListener('DOMContentLoaded', async () => {
        // Verificar sess√£o ativa
        verificarSessaoAtiva();
        
        // Carregar dados
        await loadIndicatorDetails();
        renderIndicatorMiniCards();
        
        // Configurar formul√°rio de login
        document.getElementById('login-form').addEventListener('submit', fazerLogin);
        document.querySelectorAll('.close-login').forEach(btn => {
            btn.addEventListener('click', fecharModalLogin);
        });
        
        // Configurar bot√µes de tipo de gr√°fico
        document.querySelectorAll('.chart-type-btn').forEach(btn => {
            btn.addEventListener('click', () => changeChartType(btn.dataset.type));
        });
        
        // Configurar checkbox de metas
        const metasCheckbox = document.getElementById('show-metas-checkbox');
        if (metasCheckbox) {
            metasCheckbox.addEventListener('change', (e) => {
                showMetas = e.target.checked;
                if (currentIndicatorData) {
                    const history = currentIndicatorData.history;
                    renderChart(history);
                }
            });
        }
        
        // Configurar modal de navega√ß√£o
        const modal = document.getElementById('indicator-modal');
        const openBtn = document.getElementById('indicator-navigator-btn');
        const closeBtn = document.getElementById('close-modal-btn');
        
        openBtn.addEventListener('click', () => {
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        });
        
        closeBtn.addEventListener('click', () => {
            modal.style.display = 'none';
            document.body.style.overflow = '';
        });
        
        // Configurar modal de coleta COM VERIFICA√á√ÉO DE LOGIN
        const coletaBtn = document.getElementById('coleta-dados-btn');
        const coletaModal = document.getElementById('coleta-modal');
        const closeColetaBtn = document.getElementById('close-coleta-btn');
        
        // Alterar para usar a nova fun√ß√£o com verifica√ß√£o de login
        coletaBtn.addEventListener('click', verificarLoginParaColeta);
        
        closeColetaBtn.addEventListener('click', () => {
            coletaModal.style.display = 'none';
            document.body.style.overflow = '';
        });
        
        // Fechar modais ao clicar fora
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
        });
        
        coletaModal.addEventListener('click', (e) => {
            if (e.target === coletaModal) {
                coletaModal.style.display = 'none';
                document.body.style.overflow = '';
            }
        });
        
        // Fechar modal de login ao clicar fora
        document.getElementById('login-modal').addEventListener('click', (e) => {
            if (e.target.id === 'login-modal' || e.target.classList.contains('close-login')) {
                fecharModalLogin();
            }
        });
        
        // Fechar modais ao pressionar ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                fecharModalLogin();
                document.getElementById('coleta-modal').style.display = 'none';
                document.getElementById('indicator-modal').style.display = 'none';
                document.body.style.overflow = '';
            }
        });
        
        // Redimensionamento responsivo
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                if (currentIndicatorData) {
                    const history = currentIndicatorData.history;
                    renderChart(history);
                }
            }, 100);
        });
        
        // Renderiza√ß√£o inicial
        setTimeout(() => {
            if (currentIndicatorData) {
                const history = currentIndicatorData.history;
                renderChart(history);
            }
        }, 100);
    });
    </script>
</body>
</html>