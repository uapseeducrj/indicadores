<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Indicador - Painel de Monitoramento</title>
    
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --color-primary: #003d7a;
            --color-secondary: #0074d9;
            --color-chart-line: #2196F3;
            --color-chart-area: #B3E5FC;
            --color-meta-2025: #9370db;
            --color-meta-2026: #87cefa;
            --color-hiperpositive: #00f729;
            --color-positive: #2e7d32;
            --color-negative: #c62828;
            --color-gray: #9e9e9e;
        }
        
        body, html {
            height: 100%;
            overflow: hidden;
        }
        
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        
        .chart-line {
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: all 0.3s ease;
        }
        
        .chart-point {
            transition: all 0.3s ease;
        }
        
        .chart-point:hover {
            r: 5;
            filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.2));
        }
        
        .chart-bar {
            transition: all 0.3s ease;
        }
        
        .chart-bar:hover {
            opacity: 0.8;
            transform: translateY(-2px);
        }
        
        .grid-line {
            stroke: #e5e7eb;
            stroke-width: 1;
            stroke-dasharray: 4 2;
        }
        
        .tooltip {
            transition: all 0.2s ease;
            pointer-events: none;
            z-index: 50;
        }
        
        .value-label {
            font-size: 10px;
            font-weight: 600;
            fill: #374151;
            text-anchor: middle;
            pointer-events: none;
            user-select: none;
        }
        
        /* Modal de navegação */
        .indicator-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            backdrop-filter: blur(4px);
        }
        
        .indicator-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        /* Remove scrollbars */
        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        *::-webkit-scrollbar {
            display: none;
        }
        
        /* Text overflow handling */
        .text-ellipsis-multiline {
            display: -webkit-box;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Custom styles for responsive boxes */
        .dynamic-content-box {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .dynamic-content {
            flex: 1;
            overflow: auto;
            padding: 4px 2px;
        }
        
        .dynamic-title {
            flex-shrink: 0;
            padding-top: 8px;
            border-top: 1px solid #f3f4f6;
        }
        
        /* Chart combo fix */
        .combo-chart-bar {
            opacity: 0.7;
        }
        
        .combo-chart-line {
            stroke-width: 2.5;
        }
        
        .notification-toast {
            opacity: 0;
            transform: translateX(100%);
        }
        
        /* Metas no gráfico */
        .meta-line {
            stroke-dasharray: 5, 5;
            stroke-width: 1.5;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans h-screen overflow-hidden">
    <!-- CABEÇALHO COMPACTO -->
    <header class="bg-[#074f8a] text-white shadow-sm h-12 flex items-center">
        <div class="max-w-full mx-auto px-4 w-full">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <img src="https://i.imgur.com/0wrUOlV.png" alt="SEEDUC" class="h-8 w-auto">
                    <div class="text-sm font-bold">Boletim de Indicadores</div>
                </div>
                
                <nav class="flex items-center space-x-1">
                    <a href="index.html?page=home" class="px-2 py-1 text-xs font-medium rounded hover:bg-yellow-300 hover:text-gray-900 transition-colors">
                        Home
                    </a>
                    <a href="index.html?page=estrategicos" class="px-2 py-1 text-xs font-medium rounded hover:bg-yellow-300 hover:text-gray-900 transition-colors">
                        Estratégicos
                    </a>
                    <a href="index.html?page=taticos" class="px-2 py-1 text-xs font-medium rounded hover:bg-yellow-300 hover:text-gray-900 transition-colors">
                        Táticos
                    </a>
                    <!-- BOTÃO LUPA PARA NAVEGAÇÃO -->
                    <button id="indicator-navigator-btn" class="ml-2 px-2 py-1 text-xs font-medium rounded bg-white/20 hover:bg-yellow-300 hover:text-gray-900 transition-colors flex items-center space-x-1">
                        <span class="material-symbols-outlined" style="font-size: 16px;">search</span>
                        <span class="hidden sm:inline">Navegar Indicadores</span>
                    </button>
                    <!-- BOTÃO DE COLETA DE DADOS -->
                    <button id="coleta-dados-btn" class="ml-2 px-2 py-1 text-xs font-medium rounded bg-[#2ecc71] text-white hover:bg-[#27ae60] transition-colors flex items-center space-x-1">
                        <span class="material-symbols-outlined" style="font-size: 16px;">data_check</span>
                        <span class="hidden sm:inline">Solicitar Dados</span>
                    </button>
                </nav>
            </div>
        </div>
    </header>

    <!-- MODAL DE NAVEGAÇÃO DE INDICADORES -->
    <div id="indicator-modal" class="indicator-modal">
        <div class="indicator-modal-content">
            <div class="bg-white rounded-xl shadow-2xl p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-gray-800">Navegar entre Indicadores</h3>
                    <button id="close-modal-btn" class="text-gray-500 hover:text-gray-700">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <div id="indicators-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Indicadores serão carregados aqui dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DE COLETA DE DADOS -->
    <div id="coleta-modal" class="indicator-modal">
        <div class="indicator-modal-content">
            <div class="bg-white rounded-xl shadow-2xl p-6 max-w-4xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-gray-800">Solicitação de Coleta de Dados</h3>
                    <button id="close-coleta-btn" class="text-gray-500 hover:text-gray-700">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                
                <div id="coleta-content" class="space-y-6">
                    <!-- Conteúdo será carregado dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- CONTEÚDO PRINCIPAL - SEM ROLAGEM -->
    <main class="h-[calc(100vh-3rem)] overflow-hidden">
        <div class="h-full">
            <div class="grid grid-cols-1 lg:grid-cols-3 h-full gap-3 p-3">
                <!-- COLUNA ESQUERDA (2/3) -->
                <div class="lg:col-span-2 flex flex-col h-full">
                    <!-- CARD DO GRÁFICO - ALTURA AJUSTÁVEL -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 flex-grow min-h-0 flex flex-col">
                        <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-4">
                            <div class="mb-2 sm:mb-0">
                                <h1 id="indicator-name" class="text-lg font-bold text-gray-800 truncate">Carregando detalhes do indicador...</h1>
                                <p class="text-xs text-gray-500">Série Temporal do Indicador (VALOR_1 a VALOR_6)</p>
                            </div>
                            
                            <!-- CONTROLES DISCRETOS DE VISUALIZAÇÃO -->
                            <div>
                                <div class="inline-flex rounded-lg border border-gray-200 p-0.5 bg-gray-50">
                                    <button id="chart-bar-btn" 
                                            class="chart-type-btn px-2 py-1 text-xs font-medium rounded-md transition-all duration-200 hover:bg-white hover:shadow-sm flex items-center space-x-1 active bg-white shadow-sm text-blue-600"
                                            data-type="bar">
                                        <span class="material-symbols-outlined" style="font-size: 14px;">bar_chart</span>
                                        <span class="hidden xs:inline">Barras</span>
                                    </button>
                                    <button id="chart-line-btn" 
                                            class="chart-type-btn px-2 py-1 text-xs font-medium rounded-md transition-all duration-200 hover:bg-white hover:shadow-sm flex items-center space-x-1"
                                            data-type="line">
                                        <span class="material-symbols-outlined" style="font-size: 14px;">show_chart</span>
                                        <span class="hidden xs:inline">Linhas</span>
                                    </button>
                                    <button id="chart-both-btn" 
                                            class="chart-type-btn px-2 py-1 text-xs font-medium rounded-md transition-all duration-200 hover:bg-white hover:shadow-sm flex items-center space-x-1"
                                            data-type="both">
                                        <span class="material-symbols-outlined" style="font-size: 14px;">stacked_line_chart</span>
                                        <span class="hidden xs:inline">Combo</span>
                                    </button>
                                </div>
                                
                                <!-- BOTÃO PARA MOSTRAR METAS NO GRÁFICO -->
                                <div class="mt-2 flex items-center space-x-2">
                                    <label class="flex items-center space-x-1 cursor-pointer">
                                        <input type="checkbox" id="show-metas-checkbox" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                        <span class="text-xs text-gray-600">Mostrar metas</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ÁREA DO GRÁFICO - FLEXÍVEL -->
                        <div class="flex-grow min-h-0 relative">
                            <div id="chart-container" class="absolute inset-0">
                                <svg id="chart-svg" class="w-full h-full"></svg>
                                <div id="tooltip" class="tooltip absolute hidden bg-gray-900 text-white text-xs rounded-lg py-1.5 px-2 shadow-lg"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- DETALHES E METAS - ALTURA FIXA -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3 flex-shrink-0">
                        <!-- DETALHES DO INDICADOR -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-3 text-center">
                            <h3 class="text-xs font-semibold text-gray-700 mb-2">Detalhes do Indicador</h3>
                            <div class="grid grid-cols-3 gap-2">
                                <div class="text-center p-2 bg-gray-50 rounded-lg">
                                    <div id="detail-polaridade" class="text-xl mb-1 flex justify-center">--</div>
                                    <div class="text-xs text-gray-500 uppercase tracking-wide">Polaridade</div>
                                </div>
                                <div class="text-center p-2 bg-gray-50 rounded-lg">
                                    <div id="detail-grandeza" class="text-sm font-semibold text-gray-800 mb-1">--</div>
                                    <div class="text-xs text-gray-500 uppercase tracking-wide">Grandeza</div>
                                </div>
                                <div class="text-center p-2 bg-gray-50 rounded-lg">
                                    <div id="detail-periodicidade" class="text-sm font-semibold text-gray-800 mb-1">--</div>
                                    <div class="text-xs text-gray-500 uppercase tracking-wide">Periodicidade</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- METAS -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-3 text-center">
                            <h3 class="text-xs font-semibold text-gray-700 mb-2">Metas</h3>
                            <div class="grid grid-cols-2 gap-2">
                                <div class="p-2 rounded-lg border-l-3 border-purple-500 bg-purple-50">
                                    <div id="meta-2025-value-box" class="text-sm font-bold text-gray-800 mb-1">N/A</div>
                                    <div class="text-xs text-gray-500 uppercase tracking-wide">Meta 2025</div>
                                </div>
                                <div class="p-2 rounded-lg border-l-3 border-blue-400 bg-blue-50">
                                    <div id="meta-2026-value-box" class="text-sm font-bold text-gray-800 mb-1">N/A</div>
                                    <div class="text-xs text-gray-500 uppercase tracking-wide">Meta 2026</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- COLUNA DIREITA (1/3) - SEM ROLAGEM -->
                <div class="flex flex-col h-full space-y-3 overflow-hidden">
                    <!-- STATUS -->
                    <div id="status-card" class="bg-white rounded-xl shadow-sm border-t-4 border-gray-400 p-3 text-center dynamic-content-box">
                        <div class="dynamic-content flex items-center justify-center">
                            <div id="status-value" class="text-lg font-bold text-gray-800">--</div>
                        </div>
                        <div class="text-xs text-gray-500 uppercase tracking-wide dynamic-title">Status</div>
                    </div>
                    
                    <!-- OBJETIVO ESTRATÉGICO (AGORA COM ÍCONE E CENTRALIZADO) -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-3 dynamic-content-box">
                        <div id="objetivo-estrategico" class="dynamic-content text-xs text-gray-700 text-ellipsis-multiline -webkit-line-clamp-4 flex items-center justify-center text-center px-2">
                            <div class="flex flex-col items-center justify-center h-full">
                                <!-- Ícone será inserido aqui via JavaScript -->
                                <div id="objetivo-icon" class="mb-1"></div>
                                <div id="objetivo-texto">Selecione um indicador para ver os detalhes completos</div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 uppercase tracking-wide dynamic-title">Objetivo Estratégico</div>
                    </div>
                    
                    <!-- REFERENCIAL DA META (CENTRALIZADO) -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-3 dynamic-content-box">
                        <div id="referencial-meta" class="dynamic-content text-xs text-gray-700 text-ellipsis-multiline -webkit-line-clamp-4 flex items-center justify-center text-center px-2">--</div>
                        <div class="text-xs text-gray-500 uppercase tracking-wide dynamic-title">Referencial da Meta</div>
                    </div>
                    
                    <!-- FÓRMULA (CENTRALIZADO) -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-3 dynamic-content-box">
                        <div id="formula-content" class="dynamic-content text-xs text-gray-700 text-ellipsis-multiline -webkit-line-clamp-4 flex items-center justify-center text-center px-2">--</div>
                        <div class="text-xs text-gray-500 uppercase tracking-wide dynamic-title">Fórmula</div>
                    </div>
                    
                    <!-- FONTE E RESPONSÁVEL -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-3 flex-shrink-0 text-center">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="text-center">
                                <div id="fonte-dados" class="text-xs font-semibold text-gray-800 mb-2 truncate flex items-center justify-center h-8">--</div>
                                <div class="text-xs text-gray-500 uppercase tracking-wide border-t border-gray-100 pt-1">Fonte dos Dados</div>
                            </div>
                            <div class="text-center">
                                <div id="responsavel" class="text-xs font-semibold text-gray-800 mb-2 truncate flex items-center justify-center h-8">--</div>
                                <div class="text-xs text-gray-500 uppercase tracking-wide border-t border-gray-100 pt-1">Responsável</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
    // URL DO SEU APPS SCRIPT
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyK7ZP6kE-yhep_vlu4jHmp4BfYMCNx4KUbMsmrNADAKVBtKyA0hJmc6Yoqv2_AAyLW/exec';
    
    // LISTA DE INDICADORES PARA COLETA (mantida igual)
    const INDICADORES_COLETA = [
        {
            id: 'PROF_FORMADOS_EE',
            nome: 'Profissionais formados na EE',
            formula: 'Σ Docentes e Profissionais com Formação na Educação Especial (120h)',
            periodicidade: 'Mensal',
            responsavel: 'SUPPEE'
        },
        {
            id: 'ESCOLAS_COM_AEE',
            nome: 'Escolas com salas de AEE',
            formula: '(Nº de Escolas com salas AEE / Nº total de Escolas ) * 100',
            periodicidade: 'Anual',
            responsavel: 'SUPPEE'
        },
        {
            id: 'NUM_RECURSOS_MULTIFUNC',
            nome: 'Número de recursos multifuncionais e tecnologias assistivas',
            formula: 'Σ Escolas com recursos multifuncionais',
            periodicidade: 'Semestral',
            responsavel: 'SUPPEE'
        },
        {
            id: 'AMPLIACAO_NAPS',
            nome: 'Ampliação NAPS',
            formula: 'Σ número de formações do NAPS',
            periodicidade: 'Semestral',
            responsavel: 'SUPPEE'
        }
    ];
    
    // VARIÁVEIS GLOBAIS
    let currentChartType = 'bar';
    let currentIndicatorData = null;
    let currentGrandeza = '';
    let allIndicatorsData = {};
    let showMetas = true;
    
    const colors = {
        primary: '#003d7a',
        chartLine: '#2196F3',
        current: '#003d7a',
        grid: '#e5e7eb',
        text: '#374151',
        textLight: '#6b7280',
        meta2025: '#9370db',
        meta2026: '#87cefa'
    };
    
    // FUNÇÕES BÁSICAS
    function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        return {
            indicador: params.get('indicador'),
            id: params.get('id')
        };
    }
    
    function formatValue(value, grandeza, decimals = 1) {
        if (value === null || value === undefined || value === 0) return 'N/A';
        const isPercentage = grandeza === '%';
        if (isPercentage) return (value * 100).toFixed(decimals).replace('.', ',') + '%';
        if (typeof value === 'number') return value.toFixed(decimals).replace('.', ',');
        return value.toString();
    }
    
    function normalizeStatus(status) {
        if (!status) return 'Dados em Coleta';
        const normalizedStatus = status.toString().trim();
        if (normalizedStatus === 'Dados em coleta' || normalizedStatus === 'INDICADOR EM COLETA' ||
            normalizedStatus === 'Dados em Coleta' || normalizedStatus === 'Indicador em coleta') {
            return 'Dados em Coleta';
        }
        return normalizedStatus;
    }
    
    function getStatusColor(status) {
        const normalizedStatus = normalizeStatus(status);
        switch (normalizedStatus) {
            case 'Dentro do esperado': return '#00f729';
            case 'Meta 2025 alcançada': return '#2e7d32';
            case 'Abaixo do esperado': return '#c62828';
            case 'Dados em Coleta': return '#9e9e9e';
            default: return '#6b7280';
        }
    }
    
    // FUNÇÃO PARA OBTER ÍCONES DOS OBJETIVOS (igual ao index.html)
    function getObjectiveIcon(objName) {
        if (!objName) return '<span class="material-symbols-outlined text-gray-400">target</span>';
        
        switch(objName.trim()) {
            case "Acesso à Educação":
                return '<span class="material-symbols-outlined text-blue-600">key</span>';
            case "Infraestrutura":
                return '<span class="material-symbols-outlined text-teal-600">foundation</span>';
            case "Permanência":
                return '<span class="material-symbols-outlined text-green-600">trending_up</span>';
            case "Aprendizagem Equitativa":
                return '<span class="material-symbols-outlined text-purple-600">interactive_space</span>';
            case "Educação Inclusiva e Acessível":
                return '<span class="material-symbols-outlined text-indigo-600">accessibility</span>';
            case "Regime de Colaboração":
                return '<span class="material-symbols-outlined text-orange-600">handshake</span>';
            case "Saúde e bem-estar":
                return '<span class="material-symbols-outlined text-pink-600">favorite</span>';
            case "Qualidade":
                return '<span class="material-symbols-outlined text-yellow-600">star</span>';
            case "Eficiência Operacional":
                return '<span class="material-symbols-outlined text-cyan-600">settings</span>';
            case "Gestão de Pessoas":
                return '<span class="material-symbols-outlined text-red-600">groups</span>';
            case "Tecnologia e Inovação":
                return '<span class="material-symbols-outlined text-blue-400">smart_toy</span>';
            case "Finanças":
                return '<span class="material-symbols-outlined text-green-700">payments</span>';
            case "Comunicação":
                return '<span class="material-symbols-outlined text-purple-400">campaign</span>';
            case "Sustentabilidade":
                return '<span class="material-symbols-outlined text-emerald-600">eco</span>';
            case "Segurança":
                return '<span class="material-symbols-outlined text-gray-700">shield</span>';
            case "Desenvolvimento Profissional":
                return '<span class="material-symbols-outlined text-blue-700">school</span>';
            case "Monitoramento e Avaliação":
                return '<span class="material-symbols-outlined text-indigo-400">analytics</span>';
            case "Planejamento":
                return '<span class="material-symbols-outlined text-orange-400">calendar_month</span>';
            case "Gestão Estratégica":
                return '<span class="material-symbols-outlined text-gray-800">strategy</span>';
            default:
                return '<span class="material-symbols-outlined text-gray-500">target</span>';
        }
    }
    
    // FUNÇÕES DE CARREGAMENTO DE DADOS - AGORA BUSCA DO INDEX
    async function loadData() {
        try {
            // Tenta carregar do localStorage (mesmo usado pelo index.html)
            const storedData = localStorage.getItem('dashboardData');
            if (storedData) {
                console.log('Carregando dados do localStorage compartilhado com index.html');
                return JSON.parse(storedData);
            }
            
            // Se não encontrar no localStorage, tenta buscar dados mockados como fallback
            console.log('Buscando dados mockados como fallback');
            
            // Tenta encontrar dados em diferentes chaves do localStorage
            const possibleKeys = ['dashboardDataNew', 'indicadoresData', 'rawData'];
            for (const key of possibleKeys) {
                const data = localStorage.getItem(key);
                if (data) {
                    console.log(`Encontrado dados na chave ${key}`);
                    return JSON.parse(data);
                }
            }
            
            // Último recurso: verifica se há algum dado na página
            console.warn('Nenhum dado encontrado no localStorage. Exibindo mensagem de erro.');
            return [];
            
        } catch (error) {
            console.error('Erro ao carregar dados:', error);
            return [];
        }
    }
    
    function extractHistoryFromIndicator(indicator) {
        // Extrai valores temporais de VALOR_1 a VALOR_6
        const history = [];
        
        for (let i = 1; i <= 6; i++) {
            const valorKey = `VALOR_${i}`;
            if (indicator[valorKey] && indicator[valorKey].valor !== null && indicator[valorKey].valor !== undefined) {
                history.push({
                    periodo: indicator[valorKey].periodo,
                    valor: indicator[valorKey].valor,
                    referencia: indicator[valorKey].referencia,
                    eh_data_base: indicator[valorKey].eh_data_base,
                    ordem_temporal: indicator[valorKey].ordem_temporal,
                    mes: indicator[valorKey].mes,
                    ano: indicator[valorKey].ano,
                    trimestre: indicator[valorKey].trimestre,
                    semestre: indicator[valorKey].semestre
                });
            }
        }
        
        // ORDENA DO MAIS RECENTE (VALOR_1) PARA O MAIS ANTIGO (VALOR_6)
        return history.sort((a, b) => a.ordem_temporal - b.ordem_temporal);
    }
    
    function groupDataByIndicator(data) {
        const grouped = {};
        
        data.forEach(indicator => {
            const indicatorName = indicator.INDICADORES;
            if (!indicatorName) return;
            
            if (!grouped[indicatorName]) {
                grouped[indicatorName] = {
                    details: indicator,
                    history: extractHistoryFromIndicator(indicator),
                    metas: indicator.METAS || {}
                };
            }
        });
        
        return grouped;
    }
    
    // FUNÇÕES DE COLETA DE DADOS (mantidas iguais)
    function abrirModalColeta() {
        const modal = document.getElementById('coleta-modal');
        const container = document.getElementById('coleta-content');
        
        container.innerHTML = criarConteudoColeta();
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
        
        document.querySelectorAll('.coleta-action-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const indicadorId = e.target.dataset.indicador;
                const acao = e.target.dataset.acao;
                if (acao === 'autorizar') abrirSolicitacaoTI(indicadorId);
                else if (acao === 'inserir') abrirFormularioColeta(indicadorId);
            });
        });
    }
    
    function criarConteudoColeta() {
        let html = `
            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-3">Solicite a coleta de dados para os indicadores abaixo:</p>
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <div class="bg-blue-50 p-3 rounded-lg">
                        <div class="flex items-center space-x-2">
                            <span class="material-symbols-outlined text-blue-600" style="font-size: 18px;">check_circle</span>
                            <span class="text-xs font-semibold text-blue-700">Autorizar TI</span>
                        </div>
                        <p class="text-xs text-gray-600 mt-1">Solicitar acesso aos dados via Superintendência de TI</p>
                    </div>
                    <div class="bg-orange-50 p-3 rounded-lg">
                        <div class="flex items-center space-x-2">
                            <span class="material-symbols-outlined text-orange-600" style="font-size: 18px;">edit</span>
                            <span class="text-xs font-semibold text-orange-700">Inserir Valor</span>
                        </div>
                        <p class="text-xs text-gray-600 mt-1">Inserir manualmente os dados disponíveis</p>
                    </div>
                </div>
            </div>
            <div class="space-y-4">
        `;
        
        INDICADORES_COLETA.forEach(indicador => {
            html += `
                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="text-sm font-semibold text-gray-800">${indicador.nome}</h4>
                            <p class="text-xs text-gray-600 mt-1">${indicador.formula}</p>
                        </div>
                        <span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded">${indicador.periodicidade}</span>
                    </div>
                    <div class="flex justify-between items-center mt-3">
                        <span class="text-xs text-gray-500">Responsável: ${indicador.responsavel}</span>
                        <div class="space-x-2">
                            <a href="#" class="coleta-action-link inline-block px-3 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors"
                               data-indicador="${indicador.id}" data-acao="autorizar">Autorizar TI</a>
                            <a href="#" class="coleta-action-link inline-block px-3 py-1 text-xs bg-orange-500 text-white rounded hover:bg-orange-600 transition-colors"
                               data-indicador="${indicador.id}" data-acao="inserir">Inserir Valor</a>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `</div>`;
        return html;
    }
    
    function abrirSolicitacaoTI(indicadorId) {
        const indicador = INDICADORES_COLETA.find(i => i.id === indicadorId);
        if (!indicador) return;
        const url = `${WEB_APP_URL}?acao=autorizar&indice=${indicadorId}`;
        window.open(url, '_blank');
        document.getElementById('coleta-modal').style.display = 'none';
        document.body.style.overflow = '';
    }
    
    function abrirFormularioColeta(indicadorId) {
        const indicador = INDICADORES_COLETA.find(i => i.id === indicadorId);
        if (!indicador) return;
        const url = `${WEB_APP_URL}?acao=editar&indice=${indicadorId}`;
        window.open(url, '_blank');
        document.getElementById('coleta-modal').style.display = 'none';
        document.body.style.overflow = '';
    }
    
    // FUNÇÕES PRINCIPAIS DO PAINEL
    function renderIndicatorMiniCards() {
        const container = document.getElementById('indicators-grid');
        container.innerHTML = '';
        
        if (Object.keys(allIndicatorsData).length === 0) {
            container.innerHTML = `
                <div class="col-span-1 md:col-span-2 lg:col-span-3 text-center py-8">
                    <span class="material-symbols-outlined text-gray-400 text-4xl mb-2">search_off</span>
                    <p class="text-gray-500">Nenhum indicador encontrado</p>
                    <p class="text-xs text-gray-400 mt-1">Volte ao painel principal para carregar os dados</p>
                </div>
            `;
            return;
        }
        
        Object.keys(allIndicatorsData).forEach(indicatorName => {
            const indicator = allIndicatorsData[indicatorName];
            const details = indicator.details;
            
            // Pega o valor mais recente (VALOR_1)
            const currentValue = indicator.history.length > 0 
                ? indicator.history.find(h => h.ordem_temporal === 1)?.valor 
                : 0;
            
            const status = normalizeStatus(details.Status);
            const statusColor = getStatusColor(details.Status);
            
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg border border-gray-200 p-4 hover:shadow-md transition-shadow cursor-pointer';
            card.dataset.indicator = indicatorName;
            
            card.innerHTML = `
                <div class="flex items-start justify-between mb-2">
                    <div class="text-xs text-gray-500 font-semibold">${details['#'] || ''}</div>
                    <div class="text-xs px-2 py-1 rounded-full" style="background-color: ${statusColor}20; color: ${statusColor};">
                        ${status}
                    </div>
                </div>
                <h4 class="text-sm font-semibold text-gray-800 mb-2 line-clamp-2">${indicatorName}</h4>
                <div class="text-xs text-gray-600 mb-3 line-clamp-1">${details['OBJETIVO ESTRATÉGICO'] || ''}</div>
                <div class="flex justify-between items-center">
                    <div class="text-xs text-gray-500">
                        Valor atual: <span class="font-semibold">${formatValue(currentValue, details.GRANDEZA || '', 2)}</span>
                    </div>
                    <div class="text-xs text-gray-500">${details['PERIODICIDADE DE MEDIÇÃO'] || ''}</div>
                </div>
            `;
            
            card.addEventListener('click', () => {
                const url = new URL(window.location);
                url.searchParams.set('indicador', encodeURIComponent(indicatorName));
                window.location.href = url.toString();
            });
            
            container.appendChild(card);
        });
    }
    
    async function loadIndicatorDetails() {
        try {
            const data = await loadData();
            
            if (!data || data.length === 0) {
                document.getElementById('indicator-name').textContent = 'Nenhum dado encontrado';
                document.getElementById('objetivo-texto').textContent = 'Volte ao painel principal para carregar os dados';
                return;
            }
            
            const groupedData = groupDataByIndicator(data);
            allIndicatorsData = groupedData;
            
            const params = getUrlParams();
            let indicatorName = decodeURIComponent(params.indicador || '');
            
            // Se não tem nome no URL, usa o primeiro indicador disponível
            if (!indicatorName || !groupedData[indicatorName]) {
                indicatorName = Object.keys(groupedData)[0];
                if (indicatorName) {
                    // Atualiza o URL sem recarregar
                    const url = new URL(window.location);
                    url.searchParams.set('indicador', encodeURIComponent(indicatorName));
                    window.history.replaceState({}, '', url);
                }
            }
            
            if (!indicatorName || !groupedData[indicatorName]) {
                document.getElementById('indicator-name').textContent = 'Indicador não encontrado';
                document.getElementById('objetivo-texto').textContent = 'Selecione um indicador válido';
                return;
            }
            
            const indicatorData = groupedData[indicatorName];
            currentIndicatorData = indicatorData;
            const details = indicatorData.details;
            const history = indicatorData.history; // Já vem ordenado do mais recente para o mais antigo
            currentGrandeza = details.GRANDEZA || '';
            
            // Atualizar nome do indicador
            document.getElementById('indicator-name').textContent = details.INDICADORES;
            
            // Atualizar polaridade
            const polarityElement = document.getElementById('detail-polaridade');
            polarityElement.innerHTML = '';
            const polaridade = (details.POLARIDADE || '').toString().trim();
            if (polaridade.includes('⬆️') || polaridade.toLowerCase().includes('positiva')) {
                const icon = document.createElement('span');
                icon.className = 'material-symbols-outlined';
                icon.style.cssText = 'color: #2e7d32; font-size: 20px;';
                icon.textContent = 'arrow_upward';
                polarityElement.appendChild(icon);
            } else if (polaridade.includes('⬇️') || polaridade.toLowerCase().includes('negativa')) {
                const icon = document.createElement('span');
                icon.className = 'material-symbols-outlined';
                icon.style.cssText = 'color: #c62828; font-size: 20px;';
                icon.textContent = 'arrow_downward';
                polarityElement.appendChild(icon);
            } else {
                polarityElement.textContent = '--';
            }
            
            // Atualizar outros detalhes
            document.getElementById('detail-grandeza').textContent = details.GRANDEZA || '--';
            document.getElementById('detail-periodicidade').textContent = details['PERIODICIDADE DE MEDIÇÃO'] || '--';
            
            // Atualizar objetivo estratégico COM ÍCONE
            const objetivoEstrategico = details['OBJETIVO ESTRATÉGICO'] || '--';
            const objetivoIcon = getObjectiveIcon(objetivoEstrategico);
            document.getElementById('objetivo-icon').innerHTML = objetivoIcon;
            document.getElementById('objetivo-texto').textContent = objetivoEstrategico;
            
            // Atualizar outras informações
            document.getElementById('referencial-meta').textContent = details['REFERENCIAL DA META'] || 'Baseado em crescimento histórico';
            document.getElementById('formula-content').textContent = details.FÓRMULA || 'Fórmula não especificada';
            document.getElementById('fonte-dados').textContent = details['FONTE DOS DADOS'] || '--';
            
            // Responsável: usar SUPINTENDÊNCIA ou SUBSECRETARIA
            const responsavel = details.SUPINTENDÊNCIA || details.SUBSECRETARIA || '--';
            document.getElementById('responsavel').textContent = responsavel;
            
            // Atualizar metas
            const meta2025 = details.METAS?.META_2025?.valor || details['META 2025'] || null;
            const meta2026 = details.METAS?.META_2026?.valor || details['META 2026'] || null;
            
            document.getElementById('meta-2025-value-box').textContent = formatValue(meta2025, details.GRANDEZA || '', 1);
            document.getElementById('meta-2026-value-box').textContent = formatValue(meta2026, details.GRANDEZA || '', 1);
            
            // Atualizar status
            const displayStatus = normalizeStatus(details.Status);
            document.getElementById('status-value').textContent = displayStatus || '--';
            const statusColor = getStatusColor(details.Status);
            document.getElementById('status-card').style.borderTopColor = statusColor;
            document.getElementById('status-value').style.color = statusColor;
            
            // Ajustar alturas
            adjustDynamicBoxHeights();
            
            // Renderizar gráfico
            renderChart(history, meta2025, meta2026);
            
        } catch (error) {
            console.error('Erro ao carregar detalhes do indicador:', error);
            document.getElementById('indicator-name').textContent = 'Erro ao carregar dados';
            document.getElementById('objetivo-texto').textContent = 'Ocorreu um erro ao carregar os dados do indicador';
        }
    }
    
    function adjustDynamicBoxHeights() {
        const boxes = ['objetivo-texto', 'referencial-meta', 'formula-content'];
        boxes.forEach(elementId => {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const content = element.textContent;
            const length = content.length;
            
            // Limpar classes anteriores
            element.classList.remove('-webkit-line-clamp-2', '-webkit-line-clamp-3', '-webkit-line-clamp-4', '-webkit-line-clamp-5', '-webkit-line-clamp-6');
            
            // Aplicar classe baseada no tamanho do texto
            if (length < 50) element.classList.add('-webkit-line-clamp-2');
            else if (length < 100) element.classList.add('-webkit-line-clamp-3');
            else if (length < 150) element.classList.add('-webkit-line-clamp-4');
            else if (length < 200) element.classList.add('-webkit-line-clamp-5');
            else element.classList.add('-webkit-line-clamp-6');
        });
    }
    
    function renderChart(history, meta2025, meta2026) {
        const svg = document.getElementById('chart-svg');
        svg.innerHTML = '';
        
        const container = document.getElementById('chart-container');
        const width = container.clientWidth;
        const height = container.clientHeight;
        
        if (history.length === 0) {
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', '50%');
            text.setAttribute('y', '50%');
            text.setAttribute('text-anchor', 'middle');
            text.setAttribute('fill', '#9ca3af');
            text.setAttribute('font-size', '12px');
            text.textContent = 'Sem dados temporais';
            svg.appendChild(text);
            return;
        }
        
        // Preparar dados para o gráfico - JÁ VÊM ORDENADOS DO MAIS RECENTE PARA O MAIS ANTIGO
        const chartData = history.map(item => ({
            label: item.periodo || item.referencia || `Período ${item.ordem_temporal}`,
            value: item.valor,
            ordem: item.ordem_temporal,
            eh_data_base: item.eh_data_base,
            referencia: item.referencia
        }));
        
        const values = chartData.map(d => d.value);
        const minVal = Math.min(...values);
        const maxVal = Math.max(...values);
        
        // Incluir metas no cálculo do range se necessário
        let rangeMin = minVal;
        let rangeMax = maxVal;
        
        if (showMetas) {
            if (meta2025 !== null && meta2025 !== undefined) {
                rangeMin = Math.min(rangeMin, meta2025);
                rangeMax = Math.max(rangeMax, meta2025);
            }
            if (meta2026 !== null && meta2026 !== undefined) {
                rangeMin = Math.min(rangeMin, meta2026);
                rangeMax = Math.max(rangeMax, meta2026);
            }
        }
        
        const range = rangeMax - rangeMin;
        const padding = range * 0.20 || (rangeMin === 0 ? 0.15 : rangeMin * 0.20);
        const yMin = Math.max(0, rangeMin - padding);
        const yMax = rangeMax + padding;
        const yRange = yMax - yMin;
        
        const margin = { top: 30, right: 40, bottom: 50, left: 60 };
        const chartWidth = width - margin.left - margin.right;
        const chartHeight = height - margin.top - margin.bottom;
        
        // FUNÇÕES DE ESCALA CORRIGIDAS
        const xScale = (index) => {
            if (chartData.length === 1) return margin.left + chartWidth / 2;
            const effectiveWidth = chartWidth * 0.85;
            const startOffset = chartWidth * 0.075;
            // Agora index 0 = VALOR_1 (mais recente, ESQUERDA), index último = VALOR_6 (mais antigo, DIREITA)
            return margin.left + startOffset + (index / (chartData.length - 1)) * effectiveWidth;
        };
        
        // CORREÇÃO DO EIXO Y: valores maiores ficam EM CIMA, menores EM BAIXO
        const yScale = (value) => {
            // value - yMin: quão acima do mínimo está
            // (value - yMin) / yRange: proporção (0 a 1)
            // chartHeight * (1 - proporção): invertido para valores maiores ficarem em cima
            const proportion = (value - yMin) / yRange;
            return margin.top + (chartHeight * (1 - proportion));
        };
        
        // Desenhar linhas de grade (corrigido para eixo Y invertido)
        for (let i = 0; i <= 5; i++) {
            const proportion = i / 5;
            const y = margin.top + (chartHeight * proportion); // Agora 0 = topo, 1 = base
            const value = yMax - (proportion * yRange); // Valor correspondente (maior no topo)
            
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', margin.left);
            line.setAttribute('y1', y);
            line.setAttribute('x2', width - margin.right);
            line.setAttribute('y2', y);
            line.setAttribute('class', 'grid-line');
            svg.appendChild(line);
            
            const yLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            yLabel.setAttribute('x', margin.left - 15);
            yLabel.setAttribute('y', y);
            yLabel.setAttribute('text-anchor', 'end');
            yLabel.setAttribute('dominant-baseline', 'middle');
            yLabel.setAttribute('fill', colors.textLight);
            yLabel.setAttribute('font-size', '11px');
            yLabel.setAttribute('font-weight', '500');
            yLabel.textContent = formatValue(value, currentGrandeza, 1);
            svg.appendChild(yLabel);
        }
        
        // Desenhar metas se ativadas (corrigido para eixo Y invertido)
        if (showMetas) {
            // Meta 2025
            if (meta2025 !== null && meta2025 !== undefined) {
                const yMeta2025 = yScale(meta2025);
                
                const metaLine2025 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                metaLine2025.setAttribute('x1', margin.left);
                metaLine2025.setAttribute('y1', yMeta2025);
                metaLine2025.setAttribute('x2', width - margin.right);
                metaLine2025.setAttribute('y2', yMeta2025);
                metaLine2025.setAttribute('class', 'meta-line');
                metaLine2025.setAttribute('stroke', colors.meta2025);
                metaLine2025.setAttribute('stroke-width', '1.5');
                svg.appendChild(metaLine2025);
                
                const metaLabel2025 = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                metaLabel2025.setAttribute('x', width - margin.right + 5);
                metaLabel2025.setAttribute('y', yMeta2025);
                metaLabel2025.setAttribute('text-anchor', 'start');
                metaLabel2025.setAttribute('dominant-baseline', 'middle');
                metaLabel2025.setAttribute('fill', colors.meta2025);
                metaLabel2025.setAttribute('font-size', '10px');
                metaLabel2025.setAttribute('font-weight', '600');
                metaLabel2025.textContent = `Meta 2025: ${formatValue(meta2025, currentGrandeza, 1)}`;
                svg.appendChild(metaLabel2025);
            }
            
            // Meta 2026
            if (meta2026 !== null && meta2026 !== undefined) {
                const yMeta2026 = yScale(meta2026);
                
                const metaLine2026 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                metaLine2026.setAttribute('x1', margin.left);
                metaLine2026.setAttribute('y1', yMeta2026);
                metaLine2026.setAttribute('x2', width - margin.right);
                metaLine2026.setAttribute('y2', yMeta2026);
                metaLine2026.setAttribute('class', 'meta-line');
                metaLine2026.setAttribute('stroke', colors.meta2026);
                metaLine2026.setAttribute('stroke-width', '1.5');
                svg.appendChild(metaLine2026);
                
                const metaLabel2026 = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                metaLabel2026.setAttribute('x', width - margin.right + 5);
                metaLabel2026.setAttribute('y', yMeta2026);
                metaLabel2026.setAttribute('text-anchor', 'start');
                metaLabel2026.setAttribute('dominant-baseline', 'middle');
                metaLabel2026.setAttribute('fill', colors.meta2026);
                metaLabel2026.setAttribute('font-size', '10px');
                metaLabel2026.setAttribute('font-weight', '600');
                metaLabel2026.textContent = `Meta 2026: ${formatValue(meta2026, currentGrandeza, 1)}`;
                svg.appendChild(metaLabel2026);
            }
        }
        
        // Criar pontos para o gráfico (ordenados corretamente: VALOR_1 à esquerda, VALOR_6 à direita)
        const points = chartData.map((d, i) => ({
            x: xScale(i),
            y: yScale(d.value),
            value: d.value,
            label: d.label,
            ordem: d.ordem,
            eh_data_base: d.eh_data_base,
            referencia: d.referencia
        }));
        
        // Desenhar barras (se bar ou both) - CORRIGIDA ALTURA DA BARRA
        if (currentChartType === 'bar' || currentChartType === 'both') {
            const barWidth = Math.min(30, (chartWidth * 0.85) / chartData.length * 0.7);
            
            points.forEach((point, i) => {
                const barX = point.x - barWidth / 2;
                // ALTURA CORRIGIDA: da linha de base (height - margin.bottom) até o ponto Y
                const barHeight = (height - margin.bottom) - point.y;
                const barY = point.y; // Topo da barra no ponto Y
                
                const bar = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                bar.setAttribute('x', barX);
                bar.setAttribute('y', barY);
                bar.setAttribute('width', barWidth);
                bar.setAttribute('height', barHeight);
                bar.setAttribute('class', currentChartType === 'both' ? 'combo-chart-bar' : 'chart-bar');
                bar.setAttribute('fill', point.eh_data_base ? colors.current : colors.chartLine);
                if (currentChartType === 'both') bar.setAttribute('opacity', '0.6');
                bar.setAttribute('rx', '2');
                bar.setAttribute('data-label', point.label);
                bar.setAttribute('data-value', point.value);
                bar.setAttribute('data-ordem', point.ordem);
                
                // Adicionar rótulo de valor no TOPO da barra
                if (barHeight > 25) {
                    const valueLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    valueLabel.setAttribute('x', point.x);
                    valueLabel.setAttribute('y', point.y - 10); // Acima da barra
                    valueLabel.setAttribute('text-anchor', 'middle');
                    valueLabel.setAttribute('class', 'value-label');
                    valueLabel.setAttribute('font-size', '10px');
                    valueLabel.textContent = formatValue(point.value, currentGrandeza, 2);
                    svg.appendChild(valueLabel);
                }
                
                // Eventos de hover
                bar.addEventListener('mouseenter', (e) => {
                    bar.style.opacity = currentChartType === 'both' ? '0.8' : '0.8';
                    showTooltip(e, point.label, point.value);
                });
                
                bar.addEventListener('mouseleave', () => {
                    bar.style.opacity = currentChartType === 'both' ? '0.6' : '1';
                    hideTooltip();
                });
                
                svg.appendChild(bar);
            });
        }
        
        // Desenhar linha (se line ou both)
        if (currentChartType === 'line' || currentChartType === 'both') {
            let pathData = '';
            points.forEach((point, i) => {
                pathData += (i === 0 ? `M ${point.x} ${point.y}` : ` L ${point.x} ${point.y}`);
            });
            
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            line.setAttribute('d', pathData);
            line.setAttribute('class', currentChartType === 'both' ? 'combo-chart-line' : 'chart-line');
            line.setAttribute('fill', 'none');
            line.setAttribute('stroke', colors.chartLine);
            line.setAttribute('stroke-width', currentChartType === 'both' ? '2.5' : '2');
            svg.appendChild(line);
            
            // Adicionar pontos na linha
            points.forEach(point => {
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', point.x);
                circle.setAttribute('cy', point.y);
                circle.setAttribute('r', '4');
                circle.setAttribute('class', 'chart-point');
                circle.setAttribute('fill', point.eh_data_base ? colors.current : colors.chartLine);
                circle.setAttribute('stroke', '#ffffff');
                circle.setAttribute('stroke-width', '2');
                circle.setAttribute('data-label', point.label);
                circle.setAttribute('data-value', point.value);
                circle.setAttribute('data-ordem', point.ordem);
                
                // Adicionar rótulo de valor se não tiver barra ou se for tipo linha
                if (currentChartType === 'line') {
                    const valueLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    valueLabel.setAttribute('x', point.x);
                    valueLabel.setAttribute('y', point.y - 15); // Acima do ponto
                    valueLabel.setAttribute('text-anchor', 'middle');
                    valueLabel.setAttribute('class', 'value-label');
                    valueLabel.setAttribute('font-size', '10px');
                    valueLabel.textContent = formatValue(point.value, currentGrandeza, 2);
                    svg.appendChild(valueLabel);
                }
                
                // Eventos de hover
                circle.addEventListener('mouseenter', (e) => {
                    circle.setAttribute('r', '5');
                    showTooltip(e, point.label, point.value);
                });
                
                circle.addEventListener('mouseleave', () => {
                    circle.setAttribute('r', '4');
                    hideTooltip();
                });
                
                svg.appendChild(circle);
            });
        }
        
        // Adicionar rótulos do eixo X (ordenados corretamente: VALOR_1 à esquerda, VALOR_6 à direita)
        points.forEach((point, i) => {
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', point.x);
            text.setAttribute('y', height - margin.bottom / 2);
            text.setAttribute('text-anchor', 'middle');
            text.setAttribute('fill', colors.text);
            text.setAttribute('font-size', '11px');
            text.setAttribute('font-weight', point.eh_data_base ? 'bold' : '500');
            
            // Formatar label para caber melhor
            let displayLabel = point.referencia || point.label;
            if (displayLabel.length > 10) {
                displayLabel = displayLabel.substring(0, 8) + '...';
            }
            
            text.textContent = displayLabel;
            svg.appendChild(text);
        });
        
        // Desenhar eixos
        const xAxisLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        xAxisLine.setAttribute('x1', margin.left);
        xAxisLine.setAttribute('y1', height - margin.bottom);
        xAxisLine.setAttribute('x2', width - margin.right);
        xAxisLine.setAttribute('y2', height - margin.bottom);
        xAxisLine.setAttribute('stroke', colors.grid);
        xAxisLine.setAttribute('stroke-width', '1.5');
        svg.appendChild(xAxisLine);
        
        const yAxisLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        yAxisLine.setAttribute('x1', margin.left);
        yAxisLine.setAttribute('y1', margin.top);
        yAxisLine.setAttribute('x2', margin.left);
        yAxisLine.setAttribute('y2', height - margin.bottom);
        yAxisLine.setAttribute('stroke', colors.grid);
        yAxisLine.setAttribute('stroke-width', '1.5');
        svg.appendChild(yAxisLine);
        
        // Título do eixo Y
        const yAxisTitle = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        yAxisTitle.setAttribute('x', margin.left - 45);
        yAxisTitle.setAttribute('y', margin.top + chartHeight / 2);
        yAxisTitle.setAttribute('text-anchor', 'middle');
        yAxisTitle.setAttribute('transform', `rotate(-90, ${margin.left - 45}, ${margin.top + chartHeight / 2})`);
        yAxisTitle.setAttribute('fill', colors.textLight);
        yAxisTitle.setAttribute('font-size', '11px');
        yAxisTitle.setAttribute('font-weight', '500');
        yAxisTitle.textContent = currentGrandeza || 'Valor';
        svg.appendChild(yAxisTitle);
    }
    
    function showTooltip(event, label, value) {
        const tooltip = document.getElementById('tooltip');
        const formattedValue = formatValue(value, currentGrandeza, 3);
        tooltip.innerHTML = `<div class="font-semibold">${label}</div><div class="text-gray-300">${formattedValue}</div>`;
        tooltip.style.left = (event.offsetX + 15) + 'px';
        tooltip.style.top = (event.offsetY - 50) + 'px';
        tooltip.classList.remove('hidden');
    }
    
    function hideTooltip() {
        document.getElementById('tooltip').classList.add('hidden');
    }
    
    function changeChartType(type) {
        currentChartType = type;
        document.querySelectorAll('.chart-type-btn').forEach(btn => {
            btn.classList.remove('active', 'bg-white', 'shadow-sm', 'text-blue-600');
            if (btn.dataset.type === type) {
                btn.classList.add('active', 'bg-white', 'shadow-sm', 'text-blue-600');
            }
        });
        
        if (currentIndicatorData) {
            const history = currentIndicatorData.history;
            const metas = currentIndicatorData.metas;
            const meta2025 = metas?.META_2025?.valor;
            const meta2026 = metas?.META_2026?.valor;
            renderChart(history, meta2025, meta2026);
        }
    }
    
    // INICIALIZAÇÃO
    document.addEventListener('DOMContentLoaded', async () => {
        // Carregar dados
        await loadIndicatorDetails();
        renderIndicatorMiniCards();
        
        // Configurar botões de tipo de gráfico
        document.querySelectorAll('.chart-type-btn').forEach(btn => {
            btn.addEventListener('click', () => changeChartType(btn.dataset.type));
        });
        
        // Configurar checkbox de metas
        const metasCheckbox = document.getElementById('show-metas-checkbox');
        if (metasCheckbox) {
            metasCheckbox.addEventListener('change', (e) => {
                showMetas = e.target.checked;
                if (currentIndicatorData) {
                    const history = currentIndicatorData.history;
                    const metas = currentIndicatorData.metas;
                    const meta2025 = metas?.META_2025?.valor;
                    const meta2026 = metas?.META_2026?.valor;
                    renderChart(history, meta2025, meta2026);
                }
            });
        }
        
        // Configurar modal de navegação
        const modal = document.getElementById('indicator-modal');
        const openBtn = document.getElementById('indicator-navigator-btn');
        const closeBtn = document.getElementById('close-modal-btn');
        
        openBtn.addEventListener('click', () => {
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        });
        
        closeBtn.addEventListener('click', () => {
            modal.style.display = 'none';
            document.body.style.overflow = '';
        });
        
        // Configurar modal de coleta
        const coletaBtn = document.getElementById('coleta-dados-btn');
        const coletaModal = document.getElementById('coleta-modal');
        const closeColetaBtn = document.getElementById('close-coleta-btn');
        
        coletaBtn.addEventListener('click', abrirModalColeta);
        closeColetaBtn.addEventListener('click', () => {
            coletaModal.style.display = 'none';
            document.body.style.overflow = '';
        });
        
        // Fechar modais ao clicar fora
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
        });
        
        coletaModal.addEventListener('click', (e) => {
            if (e.target === coletaModal) {
                coletaModal.style.display = 'none';
                document.body.style.overflow = '';
            }
        });
        
        // Redimensionamento responsivo
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                if (currentIndicatorData) {
                    const history = currentIndicatorData.history;
                    const metas = currentIndicatorData.metas;
                    const meta2025 = metas?.META_2025?.valor;
                    const meta2026 = metas?.META_2026?.valor;
                    renderChart(history, meta2025, meta2026);
                    adjustDynamicBoxHeights();
                }
            }, 100);
        });
        
        // Renderização inicial
        setTimeout(() => {
            if (currentIndicatorData) {
                const history = currentIndicatorData.history;
                const metas = currentIndicatorData.metas;
                const meta2025 = metas?.META_2025?.valor;
                const meta2026 = metas?.META_2026?.valor;
                renderChart(history, meta2025, meta2026);
                adjustDynamicBoxHeights();
            }
        }, 100);
    });
    </script>
</body>
</html>